name: Release

on:
 push:
  branches:
   - main

jobs:
 release:
  # prevents this action from running on forks!
  if: github.repository == 'jycouet/firstly'
  permissions:
    contents: write # to create release (changesets/action)
    id-token: write # OpenID Connect token needed for provenance
    pull-requests: write # to create pull request (changesets/action)
  name: Release
  runs-on: ubuntu-latest
  steps:
   - name: Checkout Repo
     uses: actions/checkout@v6
     with:
      # This makes Actions fetch all Git history so that Changesets can generate changelogs with the correct commits
      fetch-depth: 0

   - uses: jycouet/jycouet/shared-config/setup@main
     name: setup env
     with:
      nodeVersion: 24
      pnpmVersion: 10.13.1
     # with:
     #   nodeVersion: 18

   - name: Configure npm for trusted publishing
     run: |
      # Verify npm version supports trusted publishing (requires 11.5.1+)
      if [ $(npm --version) -lt 11.5.1 ]; then
        echo "⚠️  Warning: npm version is less than 11.5.1. Trusted publishing may not work."
        exit 1
      else
        echo "✅ npm version: $(npm --version) is 11.5.1+ (required for trusted publishing)"
      fi
      
      # Verify OIDC token is available (required for trusted publishing)
      if [ -z "$ACTIONS_ID_TOKEN_REQUEST_URL" ]; then
        echo "⚠️  Warning: OIDC token URL not found. Trusted publishing may not work."
      else
        echo "✅ OIDC token URL is available"
      fi
      
      # Trusted publishing setup instructions:
      # 1. Go to https://www.npmjs.com/package/firstly/settings
      # 2. Navigate to "Publishing access" > "Trusted Publishers"
      # 3. Click "Add a publisher" > "GitHub Actions"
      # 4. Repository: jycouet/firstly
      # 5. Workflow filename: release.yml (must match exactly, including .yml extension)
      # 6. Environment: (leave blank unless using GitHub Environments)

   - name: Create Release Pull Request or Publish to npm
     id: changesets
     uses: changesets/action@v1
     with:
      # This expects you to have a script called release which does a build for your packages and calls changeset publish
      publish: pnpm changeset:publish
      commit: ':package: RELEASE: new version'
      title: ':package: RELEASE: preparing next version'
     env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      NPM_CONFIG_PROVENANCE: true