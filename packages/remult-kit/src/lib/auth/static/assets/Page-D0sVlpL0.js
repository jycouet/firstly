var es=Object.defineProperty;var ts=(i,e,t)=>e in i?es(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var c=(i,e,t)=>(ts(i,typeof e!="symbol"?e+"":e,t),t);import{n as me,s as rs,r as vr,a as Ut,i as is,g as ns,S as pt,b as yt,c as gi,d as K,e as bi,v as rt,f as it,h as mt,j as jr,k as $t,o as Jr,l as Kt,m as ss,p as vi,q as _i,t as re,u as ue,w as os,x as de,y as as,z as ie,A as ki,B as Ii,C as Oi,D as rr,E as Ur,F as ls,G as W,H as xr,I as $,J as _r,K as At,L as us,M as be,N as Te,O as te,P as J,Q as Qe,R as Vr,T as _t,U as fs,V as Fe,W as Pe,X as Re}from"./index-tk8SV5kA.js";function cs(i,e){const t={},r={},n={$$scope:1};let s=i.length;for(;s--;){const o=i[s],a=e[s];if(a){for(const l in o)l in a||(r[l]=1);for(const l in a)n[l]||(t[l]=a[l],n[l]=1);i[s]=a}else for(const l in o)n[l]=1}for(const o in r)o in t||(t[o]=void 0);return t}const We=[];function kr(i,e){return{subscribe:ft(i,e).subscribe}}function ft(i,e=me){let t;const r=new Set;function n(a){if(Ut(i,a)&&(i=a,t)){const l=!We.length;for(const f of r)f[1](),We.push(f,i);if(l){for(let f=0;f<We.length;f+=2)We[f][0](We[f+1]);We.length=0}}}function s(a){n(a(i))}function o(a,l=me){const f=[a,l];return r.add(f),r.size===1&&(t=e(n,s)||me),a(i),()=>{r.delete(f),r.size===0&&t&&(t(),t=null)}}return{set:n,update:s,subscribe:o}}function wt(i,e,t){const r=!Array.isArray(i),n=r?[i]:i;if(!n.every(Boolean))throw new Error("derived() expects stores as input, got a falsy value");const s=e.length<2;return kr(t,(o,a)=>{let l=!1;const f=[];let u=0,d=me;const p=()=>{if(u)return;d();const w=e(r?f[0]:f,o,a);s?o(w):d=is(w)?w:me},y=n.map((w,k)=>rs(w,v=>{f[k]=v,u&=~(1<<k),l&&p()},()=>{u|=1<<k}));return l=!0,p(),function(){vr(y),d(),l=!1}})}const ds=i=>{const{subscribe:e,update:t}=ft(i);return{subscribe:e,set:(r={})=>{t(n=>Object.assign(n,r))}}},ze=ds({mode:"window",basePath:null}),Qt=(i=ns(ze).mode)=>{let e="popstate";i==="window"&&(e="popstate"),i==="hash"&&(e="hashchange"),window.dispatchEvent(new Event(e))},Hr={go:(i=0)=>{history.go(i),Qt()},push:(i,e=null)=>{history.pushState(e,"",i),Qt()},replace:(i,e=null)=>{history.replaceState(e,"",i),Qt()}},hs=(i,e)=>e===null?i:i.startsWith(e)?i.slice(e.length):i,ps=i=>{const e=i.match(/^(\/[^?#]*)?/),t=i.match(/\?([^#]*)?/),r=i.match(/#(.*)?/);return{path:(e==null?void 0:e[1])||"/",query:t!=null&&t[1]?`?${t==null?void 0:t[1]}`:"",hash:r!=null&&r[1]?`#${r==null?void 0:r[1]}`:""}},Wr=()=>{const{pathname:i,search:e,hash:t}=document.location;return{path:i,query:e,hash:t}},$r=()=>{let i=document.location.hash.substring(1);return i[0]!=="/"&&(i="/"+i),ps(i)},ys=kr(Wr(),i=>{const e=()=>i(Wr());return window.addEventListener("popstate",e),()=>window.removeEventListener("popstate",e)}),ms=kr($r(),i=>{const e=()=>i($r());return window.addEventListener("hashchange",e),()=>window.removeEventListener("hashchange",e)}),Ir=wt([ze,ys,ms],([i,e,t],r)=>{i.mode==="window"&&r(e),i.mode==="hash"&&r(t)}),ws=wt(Ir,i=>i.path);wt(Ir,i=>i.query);wt(Ir,i=>i.hash);const Gt=wt([ze,ws],([i,e])=>hs(e,i.basePath)),ot=i=>i.split(/(?=\/)/),Ei=()=>{let i=0;return()=>i++},{Error:nt}=bi;function ir(i){let e;const t=i[10].default,r=vi(t,i,i[9],null),n={c:function(){r&&r.c()},m:function(o,a){r&&r.m(o,a),e=!0},p:function(o,a){r&&r.p&&(!e||a&512)&&ki(r,t,o,o[9],e?Oi(t,o[9],a,null):Ii(o[9]),null)},i:function(o){e||(ue(r,o),e=!0)},o:function(o){de(r,o),e=!1},d:function(o){r&&r.d(o)}};return K("SvelteRegisterBlock",{block:n,id:ir.name,type:"if",source:"(96:0) {#if isRouteActive($pathWithoutBase, $route, $contextChildRoutes)}",ctx:i}),n}function nr(i){let e=sr(i[1],i[0],i[2]),t,r,n=e&&ir(i);const s={c:function(){n&&n.c(),t=_i()},l:function(a){throw new nt("options.hydrate only works if the component was compiled with the `hydratable: true` option")},m:function(a,l){n&&n.m(a,l),re(a,t,l),r=!0},p:function(a,[l]){l&7&&(e=sr(a[1],a[0],a[2])),e?n?(n.p(a,l),l&7&&ue(n,1)):(n=ir(a),n.c(),ue(n,1),n.m(t.parentNode,t)):n&&(os(),de(n,1,1,()=>{n=null}),as())},i:function(a){r||(ue(n),r=!0)},o:function(a){de(n),r=!1},d:function(a){a&&ie(t),n&&n.d(a)}};return K("SvelteRegisterBlock",{block:s,id:nr.name,type:"component",source:"",ctx:i}),s}const Kr=(i,e,t,r,n)=>{const s=(f,u,d)=>{const p=ot(u).filter(y=>y!=="/").length;return(d??0)+(f?1:p)},o=(f,u)=>{const d={invalidPath:`<Route path="${f==null?void 0:f.path}" /> has invalid path. Path must start with '/'`,fallbackOutsideRoot:"<Route fallback /> cannot be outside root <Route />",pathOutsideRoot:`<Route path="${f==null?void 0:f.path}" /> cannot be outside root <Route />`,fallbackInsideFallback:"<Route fallback /> cannot be inside <Route fallback>",pathInsideFallback:`<Route path="${f==null?void 0:f.path}" /> cannot be inside <Route fallback>`};if(f.path[0]!=="/")throw new Error(d.invalidPath);if(f.root&&f.fallback)throw new Error(d.fallbackOutsideRoot);if(f.root&&f.path!=="/")throw new Error(d.pathOutsideRoot);if(u!=null&&u.fallback&&f.fallback)throw new Error(d.fallbackInsideFallback);if(u!=null&&u.fallback&&!f.fallback)throw new Error(d.pathInsideFallback)},a=s(t,r,n==null?void 0:n.depth),l={id:i,root:e,fallback:t,path:r,depth:a};return o(l,n),l},Qr=()=>{const{subscribe:i,update:e}=ft([]);return{subscribe:i,update:t=>e(r=>[...r.filter(n=>t.id!==n.id),t]),remove:t=>e(r=>r.filter(n=>t.id!==n.id))}},sr=(i,e,t)=>{const r=(f,u,d,p)=>{let y=ot(f).filter(v=>v!=="/"),w=ot(d).filter(v=>v!=="/"),k="";if(d==="/")return u||y.length===p;for(let v=p-w.length;v<p;v++)k=k+y[v];return d===k},n=(f,u,d)=>{var w,k,v,F;let p=ot(f).filter(I=>I!=="/"),y=!1;for(let I=0;I<(d==null?void 0:d.length)&&!y;I++)(w=d[I])!=null&&w.fallback||(y=r(f,((k=d[I])==null?void 0:k.root)??!1,((v=d[I])==null?void 0:v.path)??"",((F=d[I])==null?void 0:F.depth)??0));return p.length>=u&&!y},{root:s,fallback:o,path:a,depth:l}=e;return o?n(i,l,t):r(i,s,a,l)},Gr=Ei(),kt={},zt={};function gs(i,e,t){let r,n,s,o;rt(Gt,"pathWithoutBase"),it(i,Gt,I=>t(1,s=I));let{$$slots:a={},$$scope:l}=e;mt("Route",a,["default"]);const f=Gr(),u=!jr(kt);let{fallback:d=!1}=e,{path:p="/"}=e;const y=ft();rt(y,"route"),it(i,y,I=>t(0,r=I));const w=$t(kt);rt(w,"contextRoute"),it(i,w,I=>t(8,n=I));const k=Qr(),v=$t(zt);rt(v,"contextChildRoutes"),it(i,v,I=>t(2,o=I)),Jr(()=>v==null?void 0:v.remove(r)),Kt(kt,y),Kt(zt,k);const F=["fallback","path"];return Object.keys(e).forEach(I=>{!~F.indexOf(I)&&I.slice(0,2)!=="$$"&&I!=="slot"&&console.warn(`<Route> was created with unknown prop '${I}'`)}),i.$$set=I=>{"fallback"in I&&t(6,d=I.fallback),"path"in I&&t(7,p=I.path),"$$scope"in I&&t(9,l=I.$$scope)},i.$capture_state=()=>({writable:ft,createIdIssuer:Ei,getPathSegments:ot,getRoute:Kr,createChildRoutes:Qr,isRouteActive:sr,getId:Gr,routeContextKey:kt,childRoutesContextKey:zt,onDestroy:Jr,getContext:$t,setContext:Kt,hasContext:jr,pathWithoutBase:Gt,id:f,root:u,fallback:d,path:p,route:y,contextRoute:w,childRoutes:k,contextChildRoutes:v,$route:r,$contextRoute:n,$pathWithoutBase:s,$contextChildRoutes:o}),i.$inject_state=I=>{"fallback"in I&&t(6,d=I.fallback),"path"in I&&t(7,p=I.path)},e&&"$$inject"in e&&i.$inject_state(e.$$inject),i.$$.update=()=>{i.$$.dirty&448&&ss(y,r=Kr(f,u,d,p,n),r),i.$$.dirty&1&&(v==null||v.update(r))},[r,s,o,y,w,v,d,p,n,l,a]}class at extends pt{constructor(e){super(e),yt(this,e,gs,nr,gi,{fallback:6,path:7}),K("SvelteRegisterComponent",{component:this,tagName:"Route",options:e,id:nr.name})}get fallback(){throw new nt("<Route>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set fallback(e){throw new nt("<Route>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get path(){throw new nt("<Route>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set path(e){throw new nt("<Route>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}}const zr=i=>{var a;const e=(a=i.target)==null?void 0:a.closest("a[href]"),t=e==null?void 0:e.href;if(e===null||t===null)return!0;const r=["","true"].includes(e.getAttribute("data-handle-ignore")??"false"),n=(e.getAttribute("target")??"_self")!=="_self",s=i.metaKey||i.ctrlKey||i.altKey||i.shiftKey,o=new URL(t).origin!==document.location.origin;if(r||n||s||o)return!0;t===document.location.href?Hr.replace(t):Hr.push(t),i.preventDefault()},Ci=i=>(i.addEventListener("click",zr),{destroy:()=>{i.removeEventListener("click",zr)}}),bs="home/jycouet/udev/gh/lib/remult-kit/node_modules/.pnpm/svelte-micro@2.5.6_svelte@4.2.18/node_modules/svelte-micro/dist/lib/components/Link.svelte";function or(i){let e,t,r,n;const s=i[5].default,o=vi(s,i,i[4],null);let a=[{href:i[0]},i[1]],l={};for(let u=0;u<a.length;u+=1)l=rr(l,a[u]);const f={c:function(){e=W("a"),o&&o.c(),xr(e,l),$(e,bs,15,0,417)},l:function(d){throw new Error("options.hydrate only works if the component was compiled with the `hydratable: true` option")},m:function(d,p){re(d,e,p),o&&o.m(e,null),t=!0,r||(n=[_r(Ci.call(null,e)),At(e,"click",i[6],!1,!1,!1,!1)],r=!0)},p:function(d,[p]){o&&o.p&&(!t||p&16)&&ki(o,s,d,d[4],t?Oi(s,d[4],p,null):Ii(d[4]),null),xr(e,l=cs(a,[(!t||p&1)&&{href:d[0]},p&2&&d[1]]))},i:function(d){t||(ue(o,d),t=!0)},o:function(d){de(o,d),t=!1},d:function(d){d&&ie(e),o&&o.d(d),r=!1,vr(n)}};return K("SvelteRegisterBlock",{block:f,id:or.name,type:"component",source:"",ctx:i}),f}const Xr=(i,e,t)=>(i==="hash"?"#":"")+(e??"")+t;function vs(i,e,t){let r;const n=["href"];let s=Ur(e,n),o;rt(ze,"options"),it(i,ze,d=>t(3,o=d));let{$$slots:a={},$$scope:l}=e;mt("Link",a,["default"]);let{href:f}=e;i.$$.on_mount.push(function(){f===void 0&&!("href"in e||i.$$.bound[i.$$.props.href])&&console.warn("<Link> was created without expected prop 'href'")});function u(d){us.call(this,i,d)}return i.$$set=d=>{e=rr(rr({},e),ls(d)),t(1,s=Ur(e,n)),"href"in d&&t(2,f=d.href),"$$scope"in d&&t(4,l=d.$$scope)},i.$capture_state=()=>({getFormatedHref:Xr,options:ze,linkHandle:Ci,href:f,formatedHref:r,$options:o}),i.$inject_state=d=>{"href"in e&&t(2,f=d.href),"formatedHref"in e&&t(0,r=d.formatedHref)},e&&"$$inject"in e&&i.$inject_state(e.$$inject),i.$$.update=()=>{i.$$.dirty&12&&t(0,r=Xr(o.mode,o.basePath,f))},[r,s,f,o,l,a,u]}class Or extends pt{constructor(e){super(e),yt(this,e,vs,or,gi,{href:2}),K("SvelteRegisterComponent",{component:this,tagName:"Link",options:e,id:or.name})}get href(){throw new Error("<Link>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set href(e){throw new Error("<Link>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}}function xt(i){i.focus()}const It="src/lib/modules/auth/components/ForgotPassword.svelte";function ar(i){let e,t,r,n,s,o,a=i[0].providers.password.dico.send_password_reset_instructions+"",l,f,u;const d={c:function(){e=W("div"),t=W("form"),r=W("input"),s=be(),o=W("button"),l=Te(a),te(r,"type","text"),te(r,"placeholder",n=i[0].providers.password.dico.email_placeholder),$(r,It,9,4,132),$(o,It,14,4,268),te(t,"class","s-KT008SdmQprk"),$(t,It,8,2,121),te(e,"class","login"),$(e,It,7,0,99)},l:function(y){throw new Error("options.hydrate only works if the component was compiled with the `hydratable: true` option")},m:function(y,w){re(y,e,w),J(e,t),J(t,r),J(t,s),J(t,o),J(o,l),f||(u=_r(xt.call(null,r)),f=!0)},p:function(y,[w]){w&1&&n!==(n=y[0].providers.password.dico.email_placeholder)&&te(r,"placeholder",n),w&1&&a!==(a=y[0].providers.password.dico.send_password_reset_instructions+"")&&Qe(l,a)},i:me,o:me,d:function(y){y&&ie(e),f=!1,u()}};return K("SvelteRegisterBlock",{block:d,id:ar.name,type:"component",source:"",ctx:i}),d}function _s(i,e,t){let{$$slots:r={},$$scope:n}=e;mt("ForgotPassword",r,[]);let{remultKitDataAuth:s}=e;i.$$.on_mount.push(function(){s===void 0&&!("remultKitDataAuth"in e||i.$$.bound[i.$$.props.remultKitDataAuth])&&console.warn("<ForgotPassword> was created without expected prop 'remultKitDataAuth'")});const o=["remultKitDataAuth"];return Object.keys(e).forEach(a=>{!~o.indexOf(a)&&a.slice(0,2)!=="$$"&&a!=="slot"&&console.warn(`<ForgotPassword> was created with unknown prop '${a}'`)}),i.$$set=a=>{"remultKitDataAuth"in a&&t(0,s=a.remultKitDataAuth)},i.$capture_state=()=>({autofocus:xt,remultKitDataAuth:s}),i.$inject_state=a=>{"remultKitDataAuth"in a&&t(0,s=a.remultKitDataAuth)},e&&"$$inject"in e&&i.$inject_state(e.$$inject),[s]}class Si extends pt{constructor(e){super(e),yt(this,e,_s,ar,Ut,{remultKitDataAuth:0}),K("SvelteRegisterComponent",{component:this,tagName:"ForgotPassword",options:e,id:ar.name})}get remultKitDataAuth(){throw new Error("<ForgotPassword>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set remultKitDataAuth(e){throw new Error("<ForgotPassword>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}}class qe{constructor(...e){c(this,"fields");c(this,"options");c(this,"target");c(this,"readonly");c(this,"allowNull");c(this,"dbReadOnly");c(this,"isServerExpression");c(this,"key");c(this,"caption");c(this,"inputType");c(this,"dbName");c(this,"valueType");this.fields=e}apiUpdateAllowed(e){throw new Error("Method not implemented.")}displayValue(e){throw new Error("Method not implemented.")}includedInApi(e){throw new Error("Method not implemented.")}toInput(e,t){throw new Error("Method not implemented.")}fromInput(e,t){throw new Error("Method not implemented.")}getDbName(){return Promise.resolve("")}getId(e){let t=n=>e[n.key];typeof e=="function"&&(t=e);let r="";return this.fields.forEach(n=>{r.length>0&&(r+=","),r+=n.valueConverter.toJson(t(n))}),r}get valueConverter(){throw new Error("cant get value converter of compound id")}isEqualTo(e){let t={},n=e.toString().split(",");return this.fields.forEach((s,o)=>{t[s.key]=s.valueConverter.fromJson(n[o])}),t}}function j(i,e=!0){var r;let t=i[Be];if(!t&&e)throw new Error("item "+(((r=i.constructor)==null?void 0:r.name)||i)+" was not initialized using a context");return t}const Be=Symbol.for("entityMember"),ks=Symbol.for("entityInfo"),Is=Symbol.for("entityInfo_key");function he(i,e=!0){if(i===void 0){if(e)throw new Error("Undefined is not an entity :)");return}let t=i[ks];if(!t&&e)throw new Error(i.prototype.constructor.name+" is not a known entity, did you forget to set @Entity() or did you forget to add the '@' before the call to Entity?");return t}function Os(i){return i[Is]}const Es=Symbol.for("relationInfo");function Cs(i){return i==null?void 0:i[Es]}const lr=Symbol.for("fieldRelationInfo");function U(i){return i[lr]}function Ss(i,e,t){for(const r of i.fields.toArray()){const n=Cs(r.options);if(n&&!r[lr]){const s=n.toType(),o=e.repo(s,t),a=r.options;r[lr]={type:n.type,toEntity:s,options:a,toRepo:o,getFields:()=>{let l=a.field,f={fields:a.fields,compoundIdField:void 0};function u(y){return Error(`Error for relation: "${r.key}" to "${o.metadata.key}": `+y)}let d=()=>l||f.fields;if(n.type==="toMany"&&!d()){for(const y of o.fields.toArray())if(!d()){const w=U(y),k=y.options;if(w&&w.toEntity===i.metadata.entityType){if(w.type==="reference")l=y.key;else if(w.type==="toOne"){if(k.field)l=k.field;else if(k.fields){let v={};for(const F in k.fields)if(Object.prototype.hasOwnProperty.call(k.fields,F)){const I=k.fields[F];v[I]=F}f.fields=v}}}}if(!d())throw u("No matching field found on target. Please specify field/fields")}function p(y,w){const k=w.fields.find(y);if(!k)throw u(`Field "${y}" was not found in "${w.key}".`);return k}n.type==="reference"&&(l=r.key),l&&(n.type==="toOne"||n.type==="reference"?o.metadata.idMetadata.field instanceof qe?f.compoundIdField=l:f.fields={[o.metadata.idMetadata.field.key]:l}:i.metadata.idMetadata.field instanceof qe?f.compoundIdField=l:f.fields={[l]:i.metadata.idMetadata.field.key});for(const y in f.fields)Object.prototype.hasOwnProperty.call(f.fields,y)&&(p(y,o.metadata),p(f.fields[y],i.metadata));return f}}}}}class A{constructor(e){c(this,"apply");this.apply=e}static throwErrorIfFilterIsEmpty(e,t){if(A.isFilterEmpty(e))throw{message:`${t}: requires a filter to protect against accidental delete/update of all rows`,httpStatusCode:400}}static isFilterEmpty(e){if(e.$and){for(const t of e.$and)if(!A.isFilterEmpty(t))return!1}if(e.$or){for(const t of e.$or)if(A.isFilterEmpty(t))return!0;return!1}return Object.keys(e).filter(t=>!["$or","$and"].includes(t)).length==0}static async getPreciseValues(e,t){const r=new Nt;return await A.fromEntityFilter(e,t).__applyToConsumer(r),r.preciseValues}async getPreciseValues(){const e=new Nt;return await this.__applyToConsumer(e),e.preciseValues}static createCustom(e,t=""){let r={key:t,rawFilterTranslator:e};return Object.assign(n=>{if(n==null&&(n={}),!r.key)throw"Usage of custom filter before a key was assigned to it";return{[Je+r.key]:n}},{rawFilterInfo:r})}static entityFilterToJson(e,t){return A.fromEntityFilter(e,t).toJson()}static entityFilterFromJson(e,t){return Ai(e,{get:r=>t[r]})}static fromEntityFilter(e,t){let r=[];for(const n in t)if(Object.prototype.hasOwnProperty.call(t,n)){let s=t[n];if(n=="$or")r.push(new Fs(...s.map(o=>A.fromEntityFilter(e,o))));else if(n=="$and")r.push(new Zr(...s.map(o=>A.fromEntityFilter(e,o))));else if(n.startsWith(Je))r.push(new A(o=>{o.custom(n.substring(Je.length),s)}));else if(n==Ti)r.push(new A(o=>o.databaseCustom(s)));else{const o=e.fields[n],a=U(o),l=o.options;let f=(a==null?void 0:a.type)==="toOne"?l.fields?new As(o,e.fields,l):new Ts(e.fields[l.field]):new Mt(o),u=!1;if(s!==void 0&&s!=null){s.$id!==void 0&&(s=s.$id);for(const d in s)if(Object.prototype.hasOwnProperty.call(s,d)){const p=s[d];switch(d){case"$gte":case">=":r.push(f.isGreaterOrEqualTo(p)),u=!0;break;case"$gt":case">":r.push(f.isGreaterThan(p)),u=!0;break;case"$lte":case"<=":r.push(f.isLessOrEqualTo(p)),u=!0;break;case"$lt":case"<":r.push(f.isLessThan(p)),u=!0;break;case"$ne":case"!=":case"$nin":u=!0,Array.isArray(p)?r.push(f.isNotIn(p)):r.push(f.isDifferentFrom(p));break;case"$in":u=!0,r.push(f.isIn(p));break;case"$contains":u=!0,r.push(f.contains(p));break;case"$notContains":u=!0,r.push(f.notContains(p));break}}Array.isArray(s)&&(u=!0,r.push(f.isIn(s)))}!u&&s!==void 0&&r.push(f.isEqualTo(s))}}return new Zr(...r)}__applyToConsumer(e){this.apply(e)}static async resolve(e){return typeof e=="function"?await e():e}toJson(){let e=new Er;return this.__applyToConsumer(e),e.result}static async translateCustomWhere(e,t,r){let n=new Cr(async(s,o)=>{let a=[];for(const l in t.entityType){const f=t.entityType[l];f&&f.rawFilterInfo&&f.rawFilterInfo.rawFilterTranslator&&f.rawFilterInfo.key==s&&a.push(await A.fromEntityFilter(t,await f.rawFilterInfo.rawFilterTranslator(o,r)))}return a});return e.__applyToConsumer(n),await n.resolve(),e=new A(s=>n.applyTo(s)),e}}class Mt{constructor(e){c(this,"metadata");this.metadata=e}processVal(e){if(he(this.metadata.valueType,!1)){if(e==null){if(e===null&&!this.metadata.allowNull){const r=U(this.metadata);if((r==null?void 0:r.type)==="reference")return r.toRepo.metadata.idMetadata.field.options.valueType===Number?0:""}return null}return typeof e=="string"||typeof e=="number"?e:j(e).getId()}return e}contains(e){return new A(t=>t.containsCaseInsensitive(this.metadata,e))}notContains(e){return new A(t=>t.notContainsCaseInsensitive(this.metadata,e))}isLessThan(e){return e=this.processVal(e),new A(t=>t.isLessThan(this.metadata,e))}isGreaterOrEqualTo(e){return e=this.processVal(e),new A(t=>t.isGreaterOrEqualTo(this.metadata,e))}isNotIn(e){return new A(t=>{for(const r of e)t.isDifferentFrom(this.metadata,this.processVal(r))})}isDifferentFrom(e){return e=this.processVal(e),e==null&&this.metadata.allowNull?new A(t=>t.isNotNull(this.metadata)):new A(t=>t.isDifferentFrom(this.metadata,e))}isLessOrEqualTo(e){return e=this.processVal(e),new A(t=>t.isLessOrEqualTo(this.metadata,e))}isGreaterThan(e){return e=this.processVal(e),new A(t=>t.isGreaterThan(this.metadata,e))}isEqualTo(e){return e=this.processVal(e),e==null&&this.metadata.allowNull?new A(t=>t.isNull(this.metadata)):new A(t=>t.isEqualTo(this.metadata,e))}isIn(e){return e=e.map(t=>this.processVal(t)),(e==null?void 0:e.length)==1&&e[0]!=null&&e[0]!==null?new A(t=>t.isEqualTo(this.metadata,e[0])):new A(t=>t.isIn(this.metadata,e))}}class Ts extends Mt{processVal(e){return e?typeof e=="string"||typeof e=="number"?e:j(e).getId():null}}class As{constructor(e,t,r){c(this,"metadata");c(this,"fields");c(this,"relationOptions");this.metadata=e,this.fields=t,this.relationOptions=r}processVal(e){throw new Error("Invalid for Many To One Relation Field")}contains(e){throw new Error("Invalid for Many To One Relation Field")}notContains(e){throw new Error("Invalid for Many To One Relation Field")}isLessThan(e){throw new Error("Invalid for Many To One Relation Field")}isGreaterOrEqualTo(e){throw new Error("Invalid for Many To One Relation Field")}isNotIn(e){return new A(t=>{e.forEach(r=>this.isDifferentFrom(r).__applyToConsumer(t))})}isDifferentFrom(e){return new A(t=>{const r=[];for(const n in this.relationOptions.fields)if(Object.prototype.hasOwnProperty.call(this.relationOptions.fields,n)){const s=this.relationOptions.fields[n];r.push(new A(o=>new Mt(this.fields.find(s)).isDifferentFrom(e[n]).__applyToConsumer(o)))}t.or(r)})}isLessOrEqualTo(e){throw new Error("Invalid for Many To One Relation Field")}isGreaterThan(e){throw new Error("Invalid for Many To One Relation Field")}isEqualTo(e){return new A(t=>{for(const r in this.relationOptions.fields)if(Object.prototype.hasOwnProperty.call(this.relationOptions.fields,r)){const n=this.relationOptions.fields[r];new Mt(this.fields.find(n)).isEqualTo(e[r]).__applyToConsumer(t)}})}isIn(e){return new A(t=>{t.or(e.map(r=>this.isEqualTo(r)))})}}class Zr extends A{constructor(...t){super(r=>{for(const n of this.filters)n&&n.__applyToConsumer(r)});c(this,"filters");this.filters=t}add(t){this.filters.push(t)}}class Fs extends A{constructor(...t){super(r=>{let n=this.filters.filter(s=>s!==void 0);n.length>1?r.or(n):n.length==1&&n[0].__applyToConsumer(r)});c(this,"filters");this.filters=t}}const Je="$custom$",Ti="$db$",ur="$an array";class Er{constructor(){c(this,"result",{});c(this,"hasUndefined",!1)}databaseCustom(e){throw new Error("database custom is not allowed with api calls.")}custom(e,t){Array.isArray(t)&&(t={[ur]:t}),this.add(Je+e,t)}add(e,t){t===void 0&&(this.hasUndefined=!0);let r=this.result;if(!r[e]){r[e]=t;return}let n=r[e];n instanceof Array?n.push(t):n=[n,t],r[e]=n}or(e){this.add("OR",e.map(t=>{let r=new Er;return t.__applyToConsumer(r),r.result}))}isNull(e){this.add(e.key+".null",!0)}isNotNull(e){this.add(e.key+".null",!1)}isIn(e,t){this.add(e.key+".in",t.map(r=>e.valueConverter.toJson(r)))}isEqualTo(e,t){this.add(e.key,e.valueConverter.toJson(t))}isDifferentFrom(e,t){this.add(e.key+".ne",e.valueConverter.toJson(t))}isGreaterOrEqualTo(e,t){this.add(e.key+".gte",e.valueConverter.toJson(t))}isGreaterThan(e,t){this.add(e.key+".gt",e.valueConverter.toJson(t))}isLessOrEqualTo(e,t){this.add(e.key+".lte",e.valueConverter.toJson(t))}isLessThan(e,t){this.add(e.key+".lt",e.valueConverter.toJson(t))}containsCaseInsensitive(e,t){this.add(e.key+".contains",t)}notContainsCaseInsensitive(e,t){this.add(e.key+".notContains",t)}}function Ai(i,e){let t={};function r(a){t.$and||(t.$and=[]),t.$and.push(a)}function n(a,l){t[a]===void 0?t[a]=l:r({[a]:l})}[...i.fields].forEach(a=>{function l(u,d,p=!1,y=!1){let w=e.get(a.key+u);if(w!==void 0){let k=v=>{let F=v;if(p){let Q;typeof v=="string"?Q=JSON.parse(v):Q=v,F=Q.map(x=>y?x:a.valueConverter.fromJson(x))}else F=y?F:a.valueConverter.fromJson(F);let I=d(F);I!==void 0&&n(a.key,I)};if(!p&&w instanceof Array)w.forEach(v=>{k(v)});else{p&&typeof w=="string"&&(w=JSON.parse(w));const v=o(w);for(const F of v)k(F)}}}l("",u=>u),l(".gt",u=>({$gt:u})),l(".gte",u=>({$gte:u})),l(".lt",u=>({$lt:u})),l(".lte",u=>({$lte:u})),l(".ne",u=>({$ne:u})),l(".in",u=>u,!0);var f=e.get(a.key+".null");if(f)switch(f=f.toString().trim().toLowerCase(),f){case"y":case"true":case"yes":n(a.key,null);break;default:n(a.key,{$ne:null});break}l(".contains",u=>({$contains:u}),!1,!0),l(".notContains",u=>({$notContains:u}),!1,!0)});let s=e.get("OR");if(s){const l=o(s).map(f=>({$or:f.map(u=>Ai(i,{get:d=>u[d]}))}));l.length==1?t.$or?t.$or.push(l[0].$or):t.$or=l[0].$or:r({$and:l})}for(const a in i.entityType){const l=i.entityType[a];if(l&&l.rawFilterInfo&&l.rawFilterInfo.rawFilterTranslator){let f=e.get(Je+a);if(f!==void 0){const u=d=>{d[ur]!=null&&(d=d[ur]),n(Je+a,d)};Array.isArray(f)?f.forEach(d=>u(d)):u(f)}}}return t;function o(a){if(!Array.isArray(a))return[a];const l=[],f=[];for(const u of a)Array.isArray(u)?f.push(u):l.push(u);return f.push(l),f}}class Cr{constructor(e){c(this,"translateCustom");c(this,"commands",[]);c(this,"promises",[]);this.translateCustom=e}applyTo(e){this.commands.forEach(t=>t(e))}or(e){let t;this.promises.push(Promise.all(e.map(async r=>{let n=new Cr(this.translateCustom);return r.__applyToConsumer(n),await n.resolve(),new A(s=>n.applyTo(s))})).then(r=>{t=r})),this.commands.push(r=>r.or(t))}isEqualTo(e,t){this.commands.push(r=>r.isEqualTo(e,t))}isDifferentFrom(e,t){this.commands.push(r=>r.isDifferentFrom(e,t))}isNull(e){this.commands.push(t=>t.isNull(e))}isNotNull(e){this.commands.push(t=>t.isNotNull(e))}isGreaterOrEqualTo(e,t){this.commands.push(r=>r.isGreaterOrEqualTo(e,t))}isGreaterThan(e,t){this.commands.push(r=>r.isGreaterThan(e,t))}isLessOrEqualTo(e,t){this.commands.push(r=>r.isLessOrEqualTo(e,t))}isLessThan(e,t){this.commands.push(r=>r.isLessThan(e,t))}containsCaseInsensitive(e,t){this.commands.push(r=>r.containsCaseInsensitive(e,t))}notContainsCaseInsensitive(e,t){this.commands.push(r=>r.notContainsCaseInsensitive(e,t))}isIn(e,t){this.commands.push(r=>r.isIn(e,t))}custom(e,t){this.promises.push((async()=>{let r=await this.translateCustom(e,t);r&&(Array.isArray(r)?r.forEach(n=>n.__applyToConsumer(this)):r.__applyToConsumer(this))})())}databaseCustom(e){this.commands.push(t=>t.databaseCustom(e))}async resolve(){for(;this.promises.length>0;){let e=this.promises;this.promises=[],await Promise.all(e)}}}class Nt{constructor(){c(this,"rawValues",{});c(this,"preciseValues",new Proxy(this.rawValues,{get:(e,t)=>{if(t in e){let r=e[t];if(r.bad)return;if(r.values.length>0){const n=U(r.field);if(n){if(n.type==="reference")return r.values.map(s=>n.toRepo.metadata.idMetadata.getIdFilter(s));throw new Error("Only relations toOne without field are supported.")}return r.values}}}}))}ok(e,...t){let r=this.rawValues[e.key];r?r.values.push(...t.filter(n=>!r.values.includes(n))):this.rawValues[e.key]={field:e,bad:!1,values:[...t]}}notOk(e){let t=this.rawValues[e.key];t?t.bad=!0:this.rawValues[e.key]={field:e,bad:!0,values:[]}}or(e){const t=e.map(r=>{let n=new Nt;return r.__applyToConsumer(n),n});for(const r of t)for(const n in r.rawValues)if(Object.prototype.hasOwnProperty.call(r.rawValues,n)){const s=r.rawValues[n];s&&(s.bad?this.notOk(s.field):this.ok(s.field,...s.values))}for(const r in this.rawValues)if(Object.prototype.hasOwnProperty.call(this.rawValues,r))for(const n of t)n.rawValues[r]||this.notOk(this.rawValues[r].field)}isEqualTo(e,t){this.ok(e,t)}isDifferentFrom(e,t){this.notOk(e)}isNull(e){this.ok(e,null)}isNotNull(e){this.notOk(e)}isGreaterOrEqualTo(e,t){this.notOk(e)}isGreaterThan(e,t){this.notOk(e)}isLessOrEqualTo(e,t){this.notOk(e)}isLessThan(e,t){this.notOk(e)}containsCaseInsensitive(e,t){this.notOk(e)}notContainsCaseInsensitive(e,t){this.notOk(e)}isIn(e,t){this.ok(e,...t)}custom(e,t){}databaseCustom(e){}}var Ps={};const Xt=Symbol.for("remult-static1");let Ft={defaultRemultFactory:void 0,remultFactory:void 0,defaultRemult:void 0,asyncContext:void 0,columnsOfType:new Map,allEntities:[],classHelpers:new Map,actionInfo:{allActions:[],runningOnServer:!1,runActionWithoutBlockingUI:i=>i(),startBusyWithProgress:()=>({progress:i=>{},close:()=>{}})},captionTransformer:void 0,defaultDataProvider:()=>{}};typeof process<"u"&&Ps.IGNORE_GLOBAL_REMULT_IN_TESTS||typeof globalThis[Xt]>"u"?(globalThis[Xt]=Ft,Ft.remultFactory=()=>Fi()):Ft=globalThis[Xt];const O=Ft;function Fi(){return O.defaultRemult||(O.defaultRemult=O.defaultRemultFactory()),O.defaultRemult}function Rs(){O.remultFactory=()=>Fi()}function Ue(i){const e=i;if(typeof e[ct]=="function")return e[ct]();throw Error("Error getting repository internal from "+i)}const ct=Symbol.for("getInternal");class Ds{constructor(){c(this,"iAmRemultProxy",!0);c(this,"repoCache",new Map);c(this,"repo",(...e)=>{let t=O,r=this.repoCache.get(e[0]);r||this.repoCache.set(e[0],r=new Map);let n=r.get(e[1]);return n||(n={get fields(){return O.remultFactory().repo(...e).metadata.fields},[ct](){return t.remultFactory().repo(...e)[ct]()},relations:s=>t.remultFactory().repo(...e).relations(s),validate:(s,...o)=>t.remultFactory().repo(...e).validate(s,...o),addEventListener:(...s)=>t.remultFactory().repo(...e).addEventListener(...s),count:(...s)=>t.remultFactory().repo(...e).count(...s),create:(...s)=>t.remultFactory().repo(...e).create(...s),delete:s=>t.remultFactory().repo(...e).delete(s),deleteMany:s=>t.remultFactory().repo(...e).deleteMany(s),updateMany:(...s)=>t.remultFactory().repo(...e).updateMany(...s),find:(...s)=>t.remultFactory().repo(...e).find(...s),findFirst:(...s)=>t.remultFactory().repo(...e).findFirst(...s),findOne:(...s)=>t.remultFactory().repo(...e).findOne(...s),findId:(s,o)=>t.remultFactory().repo(...e).findId(s,o),toJson:s=>t.remultFactory().repo(...e).toJson(s),fromJson:(s,o)=>t.remultFactory().repo(...e).fromJson(s,o),getEntityRef:(...s)=>t.remultFactory().repo(...e).getEntityRef(...s),insert:s=>t.remultFactory().repo(...e).insert(s),liveQuery:(...s)=>t.remultFactory().repo(...e).liveQuery(...s),get metadata(){return O.remultFactory().repo(...e).metadata},query:(...s)=>t.remultFactory().repo(...e).query(...s),save:s=>t.remultFactory().repo(...e).save(s),update:(s,o)=>t.remultFactory().repo(...e).update(s,o)},r.set(e[1],n),n)})}get liveQuerySubscriber(){return O.remultFactory().liveQuerySubscriber}set liveQuerySubscriber(e){O.remultFactory().liveQuerySubscriber=e}get liveQueryStorage(){return O.remultFactory().liveQueryStorage}set liveQueryStorage(e){O.remultFactory().liveQueryStorage=e}get liveQueryPublisher(){return O.remultFactory().liveQueryPublisher}set liveQueryPublisher(e){O.remultFactory().liveQueryPublisher=e}call(e,t,...r){return O.remultFactory().call(e,t,...r)}get context(){return O.remultFactory().context}get dataProvider(){return O.remultFactory().dataProvider}set dataProvider(e){O.remultFactory().dataProvider=e}get repCache(){return O.remultFactory().repCache}authenticated(){return O.remultFactory().authenticated()}isAllowed(e){return O.remultFactory().isAllowed(e)}isAllowedForInstance(e,t){return O.remultFactory().isAllowedForInstance(e,t)}clearAllCache(){return O.remultFactory().clearAllCache()}get user(){return O.remultFactory().user}set user(e){O.remultFactory().user=e}get apiClient(){return O.remultFactory().apiClient}set apiClient(e){O.remultFactory().apiClient=e}get subscriptionServer(){return O.remultFactory().subscriptionServer}set subscriptionServer(e){O.remultFactory().subscriptionServer=e}}const ye=new Ds;function Ms(i){return i.replace(/([A-Z])/g," $1").replace(/^./,e=>e.toUpperCase()).replace("Email","eMail").replace(" I D"," ID")}class Ns{constructor(e,t,r){c(this,"repository");c(this,"isReferenceRelation");c(this,"allowNull");c(this,"storedItem");c(this,"id");this.repository=e,this.isReferenceRelation=t,this.allowNull=r}toJson(){if(this.storedItem)return this.item===null?null:this.repository.toJson(this.item)}setId(e){this.repository.metadata.idMetadata.field.valueType==Number&&(e=+e),this.id=e}waitLoadOf(e){return e==null?null:Ue(this.repository)._getCachedByIdAsync(e,!1)}get(e){if(e==null)return null;const t=Ue(this.repository)._getCachedById(e,this.isReferenceRelation);return this.isReferenceRelation&&!this.storedItem?!this.allowNull&&(this.id===0||this.id==="")?null:void 0:t}set(e){if(e===null&&!this.allowNull&&this.isReferenceRelation&&(this.id==0||this.id=="")){this.storedItem={item:null};return}if(this.storedItem=void 0,e)if(typeof e=="string"||typeof e=="number")this.id=e;else{let t=j(e,!1);t&&!this.isReferenceRelation?(Ue(this.repository)._addToCache(e),this.id=t.getId()):(this.storedItem={item:e},this.id=e[this.repository.metadata.idMetadata.field.key])}else e===null?this.id=null:this.id=void 0}get item(){return this.storedItem?this.storedItem.item:this.get(this.id)}async waitLoad(){return this.waitLoadOf(this.id)}}class Yr{constructor(e){c(this,"url");this.url=e}add(e,t){this.url.indexOf("?")>=0?this.url+="&":this.url+="?",this.url+=encodeURIComponent(e)+"="+encodeURIComponent(t)}addObject(e,t=""){if(e!=null)for(var r in e){let n=e[r];this.add(r+t,n)}}}const Pi={error500RetryCount:4};function gt(i){if(!i)return new ei;let e;return e||Ri(i)&&(e=new Ls(i)),e||typeof i=="function"&&(e=new ei(i)),e}function Ri(i){let e=i;return!!(e&&e.get&&e.put&&e.post&&e.delete)}class Ls{constructor(e){c(this,"http");this.http=e}async post(e,t){return await Lt(()=>Ot(this.http.post(e,t)))}delete(e){return Ot(this.http.delete(e))}put(e,t){return Ot(this.http.put(e,t))}async get(e){return await Lt(()=>Ot(this.http.get(e)))}}async function Lt(i){var t,r,n,s;let e=0;for(;;)try{return await i()}catch(o){if(((t=o.message)!=null&&t.startsWith("Error occurred while trying to proxy")||(r=o.message)!=null&&r.startsWith("Error occured while trying to proxy")||(n=o.message)!=null&&n.includes("http proxy error")||(s=o.message)!=null&&s.startsWith("Gateway Timeout")||o.status==500)&&e++<Pi.error500RetryCount){await new Promise((a,l)=>{setTimeout(()=>{a({})},500)});continue}throw o}}function Ot(i){let e;return i.toPromise!==void 0?e=i.toPromise():e=i,e.then(t=>t&&(t.status==200||t.status==201)&&t.headers&&t.request&&t.data?t.data:t).catch(async t=>{throw await Bs(t)})}async function Bs(i){var s,o,a;let e=await i;var t;e.error?t=e.error:e.isAxiosError&&(typeof((s=e.response)==null?void 0:s.data)=="string"?t=e.response.data:t=(o=e==null?void 0:e.response)==null?void 0:o.data),t||(t=e.message),e.status==0&&e.error.isTrusted&&(t="Network Error"),typeof t=="string"&&(t={message:t}),e.modelState&&(t.modelState=e.modelState);let r=e.status;r===void 0&&(r=(a=e.response)==null?void 0:a.status),r!=null&&(t.httpStatusCode=r);var n=Object.assign(t,{});return n}class Di{constructor(e){c(this,"apiProvider");c(this,"isProxy",!0);this.apiProvider=e}getEntityDataProvider(e){return new qs(()=>{var r;let t=(r=this.apiProvider())==null?void 0:r.url;return t==null&&(t="/api"),t+"/"+e.key},()=>gt(this.apiProvider().httpClient),e)}async transaction(e){throw new Error("Method not implemented.")}}function Sr(i,e){if(i.include){let t={};for(const r in i.include)if(Object.prototype.hasOwnProperty.call(i.include,r)){let n=i.include[r];if(typeof n=="object"){const s=U(e.fields.find(r));s&&(n=Sr(n,s.toRepo.metadata))}t[r]=n}i={...i,include:t}}return i.where&&(i={...i,where:A.entityFilterToJson(e,i.where)}),i.load&&(i={...i,load:i.load(e.fields).map(t=>t.key)}),i}class qs{constructor(e,t,r){c(this,"url");c(this,"http");c(this,"entity");this.url=e,this.http=t,this.entity=r}translateFromJson(e){let t={};for(const r of this.entity.fields)t[r.key]=r.valueConverter.fromJson(e[r.key]);return t}translateToJson(e){let t={};for(const r of this.entity.fields)t[r.key]=r.valueConverter.toJson(e[r.key]);return t}async count(e){const{run:t}=this.buildFindRequest({where:e});return t("count").then(r=>+r.count)}async deleteMany(e){const{run:t}=this.buildFindRequest({where:e},"delete");return t("deleteMany").then(r=>+r.deleted)}async updateMany(e,t){const{run:r}=this.buildFindRequest({where:e},"put");return r("updateMany",this.toJsonOfIncludedKeys(t)).then(n=>+n.updated)}find(e){let{run:t}=this.buildFindRequest(e);return t().then(r=>r.map(n=>this.translateFromJson(n)))}buildFindRequest(e,t){t||(t="get");let r=new Yr(this.url()),n;if(e){if(e.where&&(n=e.where.toJson(),Js(n,r)&&(n=void 0)),e.orderBy&&e.orderBy.Segments){let o="",a="",l=!1;e.orderBy.Segments.forEach(f=>{o.length>0&&(o+=",",a+=","),o+=f.field.key,a+=f.isDescending?"desc":"asc",f.isDescending&&(l=!0)}),o&&r.add("_sort",o),l&&r.add("_order",a)}e.limit&&r.add("_limit",e.limit),e.page&&r.add("_page",e.page)}const s=(o,a)=>{let l=new Yr(r.url);return!o&&n&&(o="get"),o&&l.add("__action",o),n?(a={set:a,where:n},this.http().post(l.url,a)):this.http()[t](l.url,a)};return{createKey:()=>JSON.stringify({url:r,filterObject:n}),run:s,subscribe:async o=>({result:await s(Us+o),unsubscribe:async()=>O.actionInfo.runActionWithoutBlockingUI(()=>this.http().post(this.url()+"?__action=endLiveQuery",{id:o}))})}}update(e,t){return this.http().put(this.url()+(e!=""?"/"+encodeURIComponent(e):"?__action=emptyId"),this.toJsonOfIncludedKeys(t)).then(r=>this.translateFromJson(r))}toJsonOfIncludedKeys(e){let t={},r=Object.keys(e);for(const n of this.entity.fields)r.includes(n.key)&&(t[n.key]=n.valueConverter.toJson(e[n.key]));return t}async delete(e){if(e=="")await this.deleteMany(A.fromEntityFilter(this.entity,this.entity.idMetadata.getIdFilter(e)));else return this.http().delete(this.url()+"/"+encodeURIComponent(e))}insert(e){return this.http().post(this.url(),this.translateToJson(e)).then(t=>this.translateFromJson(t))}insertMany(e){return this.http().post(this.url(),e.map(t=>this.translateToJson(t))).then(t=>t.map(r=>this.translateFromJson(r)))}}class ei{constructor(e){c(this,"fetch");this.fetch=e}async get(e){return await Lt(async()=>this.myFetch(e).then(t=>t))}put(e,t){return this.myFetch(e,{method:"put",body:JSON.stringify(t)})}delete(e){return this.myFetch(e,{method:"delete"})}async post(e,t){return await Lt(()=>this.myFetch(e,{method:"post",body:JSON.stringify(t)}))}myFetch(e,t){const r={};if(t!=null&&t.body&&(r["Content-type"]="application/json"),typeof window<"u"&&typeof window.document<"u"&&typeof(window.document.cookie!=="undefined"))for(const n of window.document.cookie.split(";"))n.trim().startsWith("XSRF-TOKEN=")&&(r["X-XSRF-TOKEN"]=n.split("=")[1]);return(this.fetch||fetch)(e,{credentials:"include",method:t==null?void 0:t.method,body:t==null?void 0:t.body,headers:r}).then(n=>js(n)).catch(async n=>{throw await n})}}function js(i){if(i.status!=204){if(i.status>=200&&i.status<300)return i.json();throw i.json().then(e=>({...e,message:e.message||i.statusText,url:i.url,status:i.status})).catch(()=>{throw{message:i.statusText,url:i.url,status:i.status}})}}function Js(i,e){for(const t in i)if(Object.prototype.hasOwnProperty.call(i,t)){const r=i[t];if(Array.isArray(r)&&(r.length>0&&typeof r[0]=="object"||r.length>10))return!1}for(const t in i)if(Object.prototype.hasOwnProperty.call(i,t)){const r=i[t];Array.isArray(r)?t.endsWith(".in")?e.add(t,JSON.stringify(r)):r.forEach(n=>e.add(t,n)):t.startsWith(Je)?e.add(t,JSON.stringify(r)):e.add(t,r)}return!0}const Us="liveQuery-";var Et,xs=new Uint8Array(16);function Vs(){if(!Et&&(Et=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||typeof msCrypto<"u"&&typeof msCrypto.getRandomValues=="function"&&msCrypto.getRandomValues.bind(msCrypto),!Et))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Et(xs)}const Hs=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function Ws(i){return typeof i=="string"&&Hs.test(i)}var ee=[];for(var Zt=0;Zt<256;++Zt)ee.push((Zt+256).toString(16).substr(1));function $s(i){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,t=(ee[i[e+0]]+ee[i[e+1]]+ee[i[e+2]]+ee[i[e+3]]+"-"+ee[i[e+4]]+ee[i[e+5]]+"-"+ee[i[e+6]]+ee[i[e+7]]+"-"+ee[i[e+8]]+ee[i[e+9]]+"-"+ee[i[e+10]]+ee[i[e+11]]+ee[i[e+12]]+ee[i[e+13]]+ee[i[e+14]]+ee[i[e+15]]).toLowerCase();if(!Ws(t))throw TypeError("Stringified UUID is invalid");return t}function fr(i,e,t){i=i||{};var r=i.random||(i.rng||Vs)();if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,e){t=t||0;for(var n=0;n<16;++n)e[t+n]=r[n];return e}return $s(r)}class ce{constructor(...e){c(this,"Segments");this.Segments=e}toEntityOrderBy(){let e={};for(const t of this.Segments)t.isDescending?e[t.field.key]="desc":e[t.field.key]="asc";return e}reverse(){let e=new ce;for(const t of this.Segments)e.Segments.push({field:t.field,isDescending:!t.isDescending});return e}compare(e,t,r){r||(r=s=>s.key);let n=0;for(let s=0;s<this.Segments.length;s++){let o=this.Segments[s],a=ti(e[r(o.field)]),l=ti(t[r(o.field)]);if(a>l?n=1:a<l&&(n=-1),n!=0)return o.isDescending&&(n*=-1),n}return n}static translateOrderByToSort(e,t){if(!t)return;let r=new ce;if(t){for(const n in t)if(Object.prototype.hasOwnProperty.call(t,n)){const s=t[n];let o=e.fields.find(n);const a=l=>{switch(s){case"desc":r.Segments.push({field:l,isDescending:!0});break;case"asc":r.Segments.push({field:l})}};if(o){const l=U(o);if((l==null?void 0:l.type)==="toOne"){const f=l.options;if(typeof f.field=="string")a(e.fields.find(f.field));else if(f.fields){for(const u in f.fields)if(Object.prototype.hasOwnProperty.call(f.fields,u)){const d=f.fields[u];a(e.fields.find(d.toString()))}}}else a(o)}}}return r}static createUniqueSort(e,t){(!t||Object.keys(t).length===0)&&e.options.defaultOrderBy&&(t=ce.translateOrderByToSort(e,e.options.defaultOrderBy)),t||(t=new ce);for(const r of e.idMetadata.fields)t.Segments.find(n=>n.field==r)||t.Segments.push({field:r});return t}static createUniqueEntityOrderBy(e,t){(!t||Object.keys(t).length===0)&&(t=e.options.defaultOrderBy),t?t={...t}:t={};for(const r of e.idMetadata.fields)t[r.key]||(t[r.key]="asc");return t}}function ti(i){return i==null||i==null?i:i.id!==void 0?i.id:i}const Yt="stream";class Ks{constructor(e,t,r){c(this,"repo");c(this,"query");c(this,"queryChannel");c(this,"subscribeCode");c(this,"unsubscribe",()=>{});c(this,"defaultQueryState",[]);c(this,"listeners",[]);c(this,"id",fr());this.repo=e,this.query=t,this.queryChannel=`users:${r}:queries:${this.id}`,this.id=this.queryChannel}sendDefaultState(e){e(this.createReducerType(()=>[...this.defaultQueryState],this.allItemsMessage(this.defaultQueryState)))}async setAllItems(e){const t=await Ue(this.repo)._fromJsonArray(e,this.query.options);this.forListeners(r=>{r(()=>t)},this.allItemsMessage(t))}allItemsMessage(e){return[{type:"all",data:e}]}forListeners(e,t){e(r=>{if(this.defaultQueryState=r(this.defaultQueryState),t.find(n=>n.type==="add"||n.type==="replace")&&this.query.options.orderBy){const n=ce.translateOrderByToSort(this.repo.metadata,this.query.options.orderBy);this.defaultQueryState.sort((s,o)=>n.compare(s,o))}});for(const r of this.listeners)e(n=>{r.next(this.createReducerType(n,t))})}createReducerType(e,t){return{applyChanges:e,changes:t,items:this.defaultQueryState}}async handle(e){{let t=e.filter(({type:n})=>n=="add"||n=="replace"),r=await Ue(this.repo)._fromJsonArray(t.map(n=>n.data.item),this.query.options);for(let n=0;n<t.length;n++){const s=t[n];s.data.item=r[n]}}this.forListeners(t=>{t(r=>{r||(r=[]);for(const n of e)switch(n.type){case"all":this.setAllItems(n.data);break;case"replace":{r=r.map(s=>this.repo.metadata.idMetadata.getId(s)===n.data.oldId?n.data.item:s);break}case"add":r=r.filter(s=>this.repo.metadata.idMetadata.getId(s)!==this.repo.metadata.idMetadata.getId(n.data.item)),r.push(n.data.item);break;case"remove":r=r.filter(s=>this.repo.metadata.idMetadata.getId(s)!==n.data.id);break}return r})},e)}}const Qs="_liveQueryKeepAlive";class Gs{constructor(e,t){c(this,"apiProvider");c(this,"getUserId");c(this,"queries",new Map);c(this,"channels",new Map);c(this,"client");c(this,"interval");this.apiProvider=e,this.getUserId=t}wrapMessageHandling(e){var t=this.apiProvider().wrapMessageHandling;t?t(e):e()}hasQueriesForTesting(){return this.queries.size>0}runPromise(e){return e}close(){this.queries.clear(),this.channels.clear(),this.closeIfNoListeners()}async subscribeChannel(e,t){let r=()=>{};const n=await this.openIfNoOpened();try{let s=this.channels.get(e);if(!s){this.channels.set(e,s=new zs);try{s.unsubscribe=await n.subscribe(e,o=>this.wrapMessageHandling(()=>s.handle(o)),o=>{t.error(o)})}catch(o){throw t.error(o),o}}s.listeners.push(t),r=()=>{s.listeners.splice(s.listeners.indexOf(t),1),s.listeners.length==0&&(this.channels.delete(e),s.unsubscribe()),this.closeIfNoListeners()}}catch(s){throw t.error(s),s}return()=>{r(),r=()=>{}}}closeIfNoListeners(){this.client&&this.queries.size===0&&this.channels.size===0&&(this.runPromise(this.client.then(e=>e.close())),this.client=void 0,clearInterval(this.interval),this.interval=void 0)}subscribe(e,t,r){let n=!0,s=()=>{n=!1};return this.runPromise(Ue(e)._buildEntityDataProviderFindOptions(t).then(o=>{if(!n)return;const{createKey:a,subscribe:l}=new Di(this.apiProvider).getEntityDataProvider(e.metadata).buildFindRequest(o),f=a();let u=this.queries.get(f);u?u.sendDefaultState(r.next):(this.queries.set(f,u=new Ks(e,{entityKey:e.metadata.key,options:t},this.getUserId())),u.subscribeCode=()=>{u.unsubscribe&&(u.unsubscribe(),u.unsubscribe=()=>{}),this.runPromise(this.subscribeChannel(u.queryChannel,{next:d=>this.runPromise(u.handle(d)),complete:()=>{},error:d=>{u.listeners.forEach(p=>p.error(d))}}).then(d=>{if(u.listeners.length==0){d();return}this.runPromise(l(u.queryChannel).then(p=>{if(u.listeners.length===0){p.unsubscribe(),d();return}this.runPromise(u.setAllItems(p.result)),u.unsubscribe=()=>{u.unsubscribe=()=>{},d(),this.runPromise(p.unsubscribe())}}).catch(p=>{u.listeners.forEach(y=>y.error(p)),d(),this.queries.delete(f)}))})).catch(d=>{u.listeners.forEach(p=>p.error(d))})},u.subscribeCode()),u.listeners.push(r),s=()=>{u.listeners.splice(u.listeners.indexOf(r),1),r.complete(),u.listeners.length==0&&(this.queries.delete(f),u.unsubscribe()),this.closeIfNoListeners()}}).catch(o=>{r.error(o)})),()=>{s()}}openIfNoOpened(){return this.client?this.client:(this.interval=setInterval(async()=>{const e=[];for(const t of this.queries.values())e.push(t.queryChannel);if(e.length>0){let t=this.apiProvider();const r=await this.runPromise(await O.actionInfo.runActionWithoutBlockingUI(()=>gt(t.httpClient).post(t.url+"/"+Qs,e)));for(const n of r)for(const s of this.queries.values())s.queryChannel===n&&s.subscribeCode()}},3e4),this.runPromise(this.client=this.apiProvider().subscriptionClient.openConnection(()=>{for(const e of this.queries.values())e.subscribeCode()})))}}class zs{constructor(){c(this,"id");c(this,"unsubscribe",()=>{});c(this,"listeners",[])}async handle(e){for(const t of this.listeners)t.next(e)}}class Tr{openConnection(e){let t;const r=new Map,n=gt(ye.apiClient.httpClient);let s=!1,o;const a={close(){o.close()},async subscribe(u,d){let p=r.get(u);return p||(r.set(u,p=[]),await f(u)),p.push(d),()=>{p.splice(p.indexOf(d,1)),p.length==0&&(O.actionInfo.runActionWithoutBlockingUI(()=>n.post(ye.apiClient.url+"/"+Yt+"/unsubscribe",{channel:u,clientId:t})),r.delete(u))}}},l=()=>new Promise(u=>{p();let d=0;function p(){o&&o.close(),o=Tr.createEventSource(ye.apiClient.url+"/"+Yt),o.onmessage=y=>{let w=JSON.parse(y.data);const k=r.get(w.channel);k&&k.forEach(v=>v(w.data))},o.onerror=y=>{console.error("Live Query Event Source Error",y),o.close(),d++<Pi.error500RetryCount&&setTimeout(()=>{p()},500)},o.addEventListener("connectionId",async y=>{if(t=y.data,s){for(const w of r.keys())await f(w);e()}else s=!0,u(a)})}});return l();async function f(u){await O.actionInfo.runActionWithoutBlockingUI(()=>n.post(ye.apiClient.url+"/"+Yt+"/subscribe",{channel:u,clientId:t}))===Xs&&await l()}}static createEventSource(e){return new EventSource(e,{withCredentials:!0})}}const Xs="client connection not found",cr=Symbol.for("serverActionField");class Zs{constructor(e){c(this,"remultObjectStorage");this.remultObjectStorage=e}static enable(){O.remultFactory=()=>{const e=O.asyncContext.getStore();if(e)return e.remult;throw new Error("remult object was requested outside of a valid context, try running it within initApi or a remult request cycle")}}static disable(){Rs()}async run(e,t){return this.remultObjectStorage?this.remultObjectStorage.run({remult:e},()=>t(e)):t(e)}isInInitRequest(){var e,t;return(t=(e=this.remultObjectStorage)==null?void 0:e.getStore())==null?void 0:t.inInitRequest}setInInitRequest(e){var r;const t=(r=this.remultObjectStorage)==null?void 0:r.getStore();t&&(t.inInitRequest=e)}getStore(){if(!this.remultObjectStorage)throw new Error("can't use static remult in this environment, `async_hooks` were not initialized");return this.remultObjectStorage.getStore()}}O.asyncContext||(O.asyncContext=new Zs(void 0));function dr(){return O.actionInfo.runningOnServer||!ye.dataProvider.isProxy}class ve{constructor(e){c(this,"repo",(e,t)=>{t===void 0&&(t=this.dataProvider);let r=this.repCache.get(t);r||this.repCache.set(t,r=new Map);let n=r.get(e);return n||(r.set(e,n=new Ar(e,this,t,oo(e,this))),Ss(n,this,t)),n});c(this,"user");c(this,"dataProvider",new Di(()=>this.apiClient));c(this,"repCache",new Map);c(this,"liveQueryStorage");c(this,"subscriptionServer");c(this,"liveQueryPublisher",{itemChanged:async()=>{}});c(this,"liveQuerySubscriber",new Gs(()=>this.apiClient,()=>{var e;return(e=this.user)==null?void 0:e.id}));c(this,"context",{});c(this,"apiClient",{url:"/api",subscriptionClient:new Tr});if(e&&e.getEntityDataProvider){this.dataProvider=e;return}if(Ri(e))this.apiClient.httpClient=e;else if(typeof e=="function")this.apiClient.httpClient=e;else if(e){const t=e;t.httpClient&&(this.apiClient.httpClient=t.httpClient),t.url&&(this.apiClient.url=t.url),t.subscriptionClient&&(this.apiClient.subscriptionClient=t.subscriptionClient),t.wrapMessageHandling&&(this.apiClient.wrapMessageHandling=t.wrapMessageHandling)}}authenticated(){var e;return((e=this.user)==null?void 0:e.id)!==void 0}isAllowed(e){var t,r;if(e!=null){if(e instanceof Array){for(const n of e)if(this.isAllowed(n)===!0)return!0;return!1}return typeof e=="function"?e(this):typeof e=="boolean"?e:!!(typeof e=="string"&&(r=(t=this.user)==null?void 0:t.roles)!=null&&r.includes(e.toString()))}}isAllowedForInstance(e,t){if(Array.isArray(t)){for(const r of t)if(this.isAllowedForInstance(e,r))return!0}else return typeof t=="function"?t(e,this):this.isAllowed(t)}call(e,t,...r){const n=e[cr];if(!n.doWork)throw Error("The method received is not a valid backend method");return n.doWork(r,t,this.apiClient.url,gt(this.apiClient.httpClient))}clearAllCache(){this.repCache.clear()}}c(ve,"onFind",(e,t)=>{}),c(ve,"entityRefInit");O.defaultRemultFactory=()=>new ve;class Ys{constructor(){c(this,"classes",new Map)}}const eo={defaultPageSize:200};async function Mi(i,e){const t=new to(i.liveQueryPublisher);let r=!0;const n=i.dataProvider;try{await i.dataProvider.transaction(async s=>{i.dataProvider=s,i.liveQueryPublisher=t,await e(s),r=!0}),r&&await t.flush()}finally{i.dataProvider=n}}class to{constructor(e){c(this,"orig");c(this,"transactionItems",new Map);this.orig=e}async itemChanged(e,t){let r=this.transactionItems.get(e);r||this.transactionItems.set(e,r=[]);for(const n of t)if(n.oldId!==void 0){const s=r.find(o=>o.id===n.oldId);s!==void 0?(n.deleted&&(s.deleted=!0),n.id!=s.id&&(s.id=n.id)):r.push(n)}else r.push(n)}async flush(){for(const e of this.transactionItems.keys())await this.orig.itemChanged(e,this.transactionItems.get(e))}}function hr(i,e){return e&&Object.assign(i,e),i}class _e{}c(_e,"number","number"),c(_e,"date","date"),c(_e,"checkbox","checkbox"),c(_e,"password","password"),c(_e,"email","email"),c(_e,"tel","tel"),c(_e,"time","time");const R=class R{};c(R,"Date",{toJson:e=>{if(e===null)return null;if(!e)return"";if(typeof e=="string"&&(e=new Date(e)),e instanceof Date)return e.toISOString();throw new Error("Expected date but got "+e)},fromJson:e=>{if(e===null)return null;if(e!=null&&e!=""&&!e.startsWith("0000-00-00"))return new Date(Date.parse(e))},toDb:e=>e,fromDb:e=>{if(typeof e=="number"&&(e=new Date(e)),typeof e=="string"&&(e=new Date(e)),e&&!(e instanceof Date))throw"expected date but got "+e;return e},fromInput:e=>R.Date.fromJson(e),toInput:e=>R.Date.toJson(e),displayValue:e=>e?e.toLocaleString():""}),c(R,"DateOnly",{fromInput:e=>R.DateOnly.fromJson(e),toInput:e=>R.DateOnly.toJson(e),toJson:e=>{var t=e;return(typeof t=="string"||typeof t=="number")&&(t=new Date(t)),!t||t==null?null:t.getHours()==0?new Date(t.valueOf()-t.getTimezoneOffset()*6e4).toISOString().substring(0,10):t.toISOString().substring(0,10)},fromJson:e=>{if(!e||e==""||e=="0000-00-00")return null;let t=new Date(Date.parse(e));return t.setMinutes(t.getMinutes()+t.getTimezoneOffset()),t},inputType:_e.date,toDb:e=>e?R.DateOnly.fromJson(R.DateOnly.toJson(e)):null,fromDb:e=>R.Date.fromDb(e),fieldTypeInDb:"date",displayValue:e=>e?e.toLocaleDateString(void 0):""}),c(R,"DateOnlyString",{...R.DateOnly,toDb:e=>{let t=R.DateOnly.toJson(e);if(t)return t.replace(/-/g,"")},fromDb:e=>{if(e===null)return null;if(e)return new Date(e.substring(0,4)+"-"+e.substring(4,6)+"-"+e.substring(6,8))}}),c(R,"Boolean",{toDb:e=>e,inputType:_e.checkbox,fromDb:e=>R.Boolean.fromJson(e),fromJson:e=>typeof e=="boolean"?e:e===1?!0:e!=null?e.toString().trim().toLowerCase()=="true":e,toJson:e=>e,fromInput:e=>R.Boolean.fromJson(e),toInput:e=>R.Boolean.toJson(e)}),c(R,"Number",{fromDb:e=>{if(e===null)return null;if(e!==void 0)return+e},toDb:e=>e,fromJson:e=>R.Number.fromDb(e),toJson:e=>R.Number.toDb(e),fromInput:(e,t)=>{let r=+e;if(e!=null)return r},toInput:(e,t)=>e==null?void 0:e.toString(),inputType:_e.number}),c(R,"String",{fromDb:$e,toDb:$e,fromJson:$e,toJson:$e,fromInput:$e,toInput:$e}),c(R,"Integer",{...R.Number,toJson:e=>{let t=R.Number.toDb(e);return t&&+(+t).toFixed(0)},toDb:e=>R.Integer.toJson(e),fieldTypeInDb:"integer"}),c(R,"Default",{fromJson:e=>e,toJson:e=>e,fromDb:e=>R.JsonString.fromDb(e),toDb:e=>R.JsonString.toDb(e),fromInput:e=>R.Default.fromJson(e),toInput:e=>R.Default.toJson(e),displayValue:e=>e+"",fieldTypeInDb:"",inputType:"text"}),c(R,"JsonString",{fromJson:e=>e,toJson:e=>e,fromDb:e=>e==null?null:e?JSON.parse(R.JsonString.fromJson(e)):void 0,toDb:e=>e!==void 0?e===null?null:JSON.stringify(R.JsonString.toJson(e)):void 0,fromInput:e=>R.JsonString.fromJson(e),toInput:e=>R.JsonString.toJson(e)}),c(R,"JsonValue",{fromJson:e=>e,toJson:e=>e,fromDb:e=>e,toDb:e=>e,fromInput:e=>R.JsonString.fromJson(e),toInput:e=>R.JsonString.toJson(e),fieldTypeInDb:"json"});let ae=R;function $e(i){return i==null?i:typeof i!="string"?i.toString():i}function ri(i,e,t){let r=A.fromEntityFilter(i,e);const n=()=>{};r&&r.__applyToConsumer({custom:n,databaseCustom:n,containsCaseInsensitive:n,notContainsCaseInsensitive:n,isDifferentFrom:n,isEqualTo:(s,o)=>{t[s.key]=o},isGreaterOrEqualTo:n,isGreaterThan:n,isIn:n,isLessOrEqualTo:n,isLessThan:n,isNotNull:n,isNull:n,or:n})}class ii{constructor(){c(this,"entityLoaders",new Map);c(this,"promises",[])}load(e,t){let r=this.entityLoaders.get(e.entityType);r||this.entityLoaders.set(e.entityType,r=new ro(e));const n=r.find(t);return this.promises.push(n),n}async resolveAll(){for(const t of this.entityLoaders.values())for(const r of t.queries.values())r.resolve();if(this.promises.length===0)return;const e=this.promises;this.promises=[],await Promise.all(e),await this.resolveAll()}}class ro{constructor(e){c(this,"rel");c(this,"queries",new Map);this.rel=e}find(e){const{where:t,...r}=Sr(e,this.rel.metadata),n=JSON.stringify(r);let s=this.queries.get(n);return s||this.queries.set(n,s=new io(this.rel)),s.find(e,t)}}class io{constructor(e){c(this,"rel");c(this,"pendingInStatements",new Map);c(this,"whereVariations",new Map);this.rel=e}find(e,t){const r=JSON.stringify(t);let n=this.whereVariations.get(r);if(!n){const s=Object.keys(t);if(s.length===1&&typeof t[s[0]]!="object"&&!e.limit){let o=this.pendingInStatements.get(s[0]);o||this.pendingInStatements.set(s[0],o=new no(this.rel,s[0],e)),this.whereVariations.set(r,n={result:o.find(t)})}else this.whereVariations.set(r,n={result:this.rel.find(e)})}return n.result}resolve(){const e=[...this.pendingInStatements.values()];this.pendingInStatements.clear();for(const t of e)t.resolve()}}class no{constructor(e,t,r){c(this,"rel");c(this,"key");c(this,"options");c(this,"values",new Map);this.rel=e,this.key=t,this.options=r}async resolve(){const e=[...this.values.values()];if(e.length==1){this.rel.find(this.options).then(e[0].resolve,e[0].reject);return}var t={...this.options};t.where={[this.key]:e.map(n=>n.value)},t.limit=1e3,t.page=1;let r=[];try{for(;;){const n=await this.rel.find(t);if(r.push(...n),n.length<t.limit)break;t.page++}for(const n of this.values.values())n.resolve(r.filter(s=>{const a=j(s).fields.find(this.key),l=U(a.metadata),f=(l==null?void 0:l.type)==="reference"?a.getId():s[this.key];return n.value==f}))}catch(n){for(const s of this.values.values())s.reject(n)}}find(e){const t=e[this.key];let r=this.values.get(t);if(!r){let n,s,o=new Promise((a,l)=>{n=a,s=l});this.values.set(t,r={value:t,resolve:n,reject:s,result:o})}return r.result}}const oe=class oe{};c(oe,"required",st(async(e,t)=>t.value!=null&&t.value!=null&&t.value!=="","Should not be empty")),c(oe,"unique",st(async(e,t)=>{if(!t.entityRef)throw"unique validation may only work on columns that are attached to an entity";return t.isBackend()&&(t.isNew||t.valueChanged())?await t.entityRef.repository.count({[t.metadata.key]:t.value})==0:!0},"already exists")),c(oe,"uniqueOnBackend",st(async(e,t)=>t.isBackend()&&(t.isNew||t.valueChanged())?await t.entityRef.repository.count({[t.metadata.key]:t.value})==0:!0,oe.unique.defaultMessage)),c(oe,"regex",et((e,t)=>t.test(e))),c(oe,"email",Pt(e=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e),"Invalid Email")),c(oe,"url",Pt(e=>!!new URL(e),"Invalid Url")),c(oe,"in",et((e,t)=>t.includes(e),e=>`Value must be one of: ${e.map(t=>typeof t=="object"?t.id!==void 0?t.id:t.toString():t).join(", ")}`)),c(oe,"notNull",Pt(e=>e!=null,"Should not be null")),c(oe,"enum",et((e,t)=>Object.values(t).includes(e),e=>`Value must be one of ${Rt(e).join(", ")}`)),c(oe,"relationExists",st(async(e,t)=>t.valueIsNull()||!t.isBackend()?!0:!!await t.load(),"Relation value does not exist")),c(oe,"maxLength",et((e,t)=>e.length<=t,e=>`Value must be at most ${e} characters`)),c(oe,"minLength",et((e,t)=>e.length>=t,e=>`Value must be at least ${e} characters`)),c(oe,"defaultMessage","Invalid value");let Ce=oe;function st(i,e){const t=async(n,s,o)=>{const a=await i(n,s);typeof a=="string"&&a.length>0?s.error=a:a||(s.error=typeof o=="function"&&o(n,s,void 0)||o||typeof e=="function"&&e(n,s,void 0)||e||Ce.defaultMessage)},r=(n,s,o)=>typeof n=="string"||n==="function"||n===void 0&&s===void 0?async(a,l,f)=>await t(a,l,n||f):t(n,s,o);return Object.defineProperty(r,"defaultMessage",{get:()=>e,set:n=>{e=n},enumerable:!0}),Object.assign(r,{withMessage:n=>async(s,o)=>r(s,o,n)})}function Pt(i,e){return st((t,r)=>r.value===void 0||r.value===null?!0:i(r.value),e)}function et(i,e){const t=so((r,n,s)=>n.value===void 0||n.value===null?!0:i(n.value,s),(r,n,s)=>typeof e=="function"&&e(s)||e,!0);return Object.assign((r,n)=>t(r,n),{get defaultMessage(){return e},set defaultMessage(r){e=r}})}function so(i,e,t=!1){return Object.assign((n,s)=>async(o,a)=>{const l=await i(o,a,n);typeof l=="string"?a.error=l:l||(a.error=s?typeof s=="function"?t?s(n):s(o,a,n):s:e?typeof e=="function"?e(o,a,n):e:Ce.defaultMessage)},{get defaultMessage(){return e},set defaultMessage(n){e=n}})}function Rt(i){return Object.values(i).filter(e=>typeof i[e]!="number")}function Dt(i,e,t=!1){if(!e)return i;const r=Array.isArray(e)?e:[e],n=Array.isArray(i)?i:i?[i]:[];return t?[...r,...n]:[...n,...r]}function er(i,e){return typeof i[e]<"u"}class Ar{constructor(e,t,r,n,s){c(this,"_entity");c(this,"_remult");c(this,"_dataProvider");c(this,"_info");c(this,"_defaultFindOptions");c(this,"__edp");c(this,"_idCache",new Map);c(this,"listeners");c(this,"_cache",new Map);this._entity=e,this._remult=t,this._dataProvider=r,this._info=n,this._defaultFindOptions=s}_notFoundError(e){return{message:`id ${e} not found in entity ${this.metadata.key}`,httpStatusCode:404}}[ct](){return this}async _createAfterFilter(e,t){let r=new Map;for(const o of ce.translateOrderByToSort(this.metadata,e).Segments){let a=t[o.field.key];r.set(o.field.key,a)}let n={$or:[]},s=[];for(const o of ce.translateOrderByToSort(this.metadata,e).Segments){let a={};for(const l of s)a[l.key]=r.get(l.key);s.push(o.field),o.isDescending?a[o.field.key]={$lt:r.get(o.field.key)}:a[o.field.key]={$gt:r.get(o.field.key)},n.$or.push(a)}return n}relations(e){return new Proxy({},{get:(t,r)=>{const n=this.fields.find(r),s=U(n);if(!s)throw Error(r+" is not a relation");const{toRepo:o,returnNull:a,returnUndefined:l}=this._getFocusedRelationRepo(n,e);return s.type==="toMany"?o:{findOne:f=>a?Promise.resolve(null):l?Promise.resolve(void 0):o.findFirst({},f)}}})}_getFocusedRelationRepo(e,t){const r=U(e);let n=r.toRepo,{findOptions:s,returnNull:o,returnUndefined:a}=this._findOptionsBasedOnRelation(r,e,void 0,t,n);return{toRepo:new Ar(n._entity,n._remult,n._dataProvider,n._info,s),returnNull:o,returnUndefined:a}}get _edp(){return this.__edp?this.__edp:this.__edp=this._dataProvider.getEntityDataProvider(this.metadata)}_getCachedById(e,t){e=e+"",this._getCachedByIdAsync(e,t);let r=this._idCache.get(e);if(!(r instanceof Promise))return r}async _getCachedByIdAsync(e,t){e=e+"";let r=this._idCache.get(e);if(r instanceof Promise)return await r;if(this._idCache.has(e))return r;if(t)return;this._idCache.set(e,void 0);let n=this.findId(e).then(s=>(s===void 0?r=null:r=s,this._idCache.set(e,r),r));return this._idCache.set(e,n),await n}_addToCache(e){e&&this._idCache.set(this.getEntityRef(e).getId()+"",e)}get metadata(){return this._info}addEventListener(e){return this.listeners||(this.listeners=[]),this.listeners.push(e),()=>{this.listeners.splice(this.listeners.indexOf(e),1)}}query(e){return new po(e,this)}getEntityRef(e){let t=e[Be];return t||(this._fixTypes(e),t=new Ct(this._info,e,this,this._edp,this._remult,!0),Object.defineProperty(e,Be,{get:()=>t}),t.saveOriginalData()),t}async delete(e){const t=j(e,!1);if(t)return t.delete();if(typeof e=="string"||typeof e=="number"){if(this._dataProvider.isProxy)return this._edp.delete(e);{let n=await this.findId(e);if(!n)throw this._notFoundError(e);return await j(n).delete()}}let r=this._getRefForExistingRow(e,void 0);return this._dataProvider.isProxy||await r.reload(),r.delete()}async insert(e){if(Array.isArray(e))if(this._dataProvider.isProxy){let t=[],r=[];for(const n of e){let s=j(e,!1);if(s){if(!s.isNew())throw"Item is not new"}else s=await this.getEntityRef(this.create(n));t.push(s),r.push(await s.buildDtoForInsert())}return lt(await this._edp.insertMany(r),(n,s)=>t[s].processInsertResponseDto(n))}else{let t=[];for(const r of e)t.push(await this.insert(r));return t}else{let t=j(e,!1);if(t){if(!t.isNew())throw"Item is not new";return await t.save()}else return await this.getEntityRef(this.create(e)).save()}}get fields(){return this.metadata.fields}async validate(e,...t){{let r=j(e,!1);if(r||(r=this.getEntityRef({...e})),!t||t.length===0)return await r.validate();{r.__clearErrorsAndReportChanged();let n=!1;for(const s of t)await r.fields.find(s).validate()||(n=!0);return n?r.buildErrorInfoObject():void 0}}}async updateMany({where:e,set:t}){if(A.throwErrorIfFilterIsEmpty(e,"updateMany"),this._dataProvider.isProxy)return this._edp.updateMany(await this._translateWhereToFilter(e),t);{let r=0;for await(const n of this.query({where:e}))hr(n,t),await j(n).save(),r++;return r}}async update(e,t){{let n=j(t,!1);if(n)return await n.save()}{let n=j(e,!1);if(n)return hr(e,t),n.save()}let r;if(typeof e=="object"?(r=this._getRefForExistingRow(e,this.metadata.idMetadata.getId(e)),Object.assign(r.instance,t)):r=this._getRefForExistingRow(t,e),this._dataProvider.isProxy)return await r.save(Object.keys(t));{const n=await r.reload();if(!n)throw this._notFoundError(r.id);for(const s in t)if(Object.prototype.hasOwnProperty.call(t,s)){let o=r.fields[s];if(t[s]===void 0&&U(o.metadata))continue;o&&(n[s]=t[s])}return await this._fixTypes(n),await r.save()}}_getRefForExistingRow(e,t){let r=j(e,!1);if(!r){const n=new this._entity(this._remult);for(const o of this._fieldsOf(e))n[o.key]=e[o.key];this._fixTypes(n);let s=new Ct(this._info,n,this,this._edp,this._remult,!1);typeof t=="object"&&(t=this.metadata.idMetadata.getId(t)),t?(s.id=t,s.originalId=t):s.id=s.getId(),r=s,Object.defineProperty(n,Be,{get:()=>s})}return r}async save(e){if(Array.isArray(e))return lt(e,t=>this.save(t));{let t=j(e,!1);if(t)return await t.save();if(e instanceof Ji)return await this.getEntityRef(e).save();{let r=this.metadata.idMetadata.getId(e);return r===void 0?this.insert(e):this.update(r,e)}}}liveQuery(e){return e||(e={}),{subscribe:t=>{let r=t;return typeof t=="function"&&(r={next:t,complete:()=>{},error:()=>{}}),r.error??(r.error=()=>{}),r.complete??(r.complete=()=>{}),this._remult.liveQuerySubscriber.subscribe(this,e,r)}}}async _rawFind(e,t=!1,r){e||(e={}),this._defaultFindOptions&&(e={...this._defaultFindOptions,...e});let n=await this._buildEntityDataProviderFindOptions(e);t&&(delete n.orderBy,delete n.limit),ve.onFind(this._info,e);const s=await this._edp.find(n);return await this._loadManyToOneForManyRows(s,e,r)}async find(e,t=!1){const r=new ii,n=await this._rawFind(e,t,r);return await r.resolveAll(),n}async _buildEntityDataProviderFindOptions(e){let t={};return t={},(!e.orderBy||Object.keys(e.orderBy).length===0)&&(e.orderBy=this._info.entityInfo.defaultOrderBy),t.where=await this._translateWhereToFilter(e.where),e.orderBy!==void 0&&(t.orderBy=ce.translateOrderByToSort(this.metadata,e.orderBy)),e.limit!==void 0&&(t.limit=e.limit),e.page!==void 0&&(t.page=e.page),t}async _fromJsonArray(e,t){const r=new ii,n=await this._loadManyToOneForManyRows(e.map(s=>{let o={};for(const a of this.metadata.fields.toArray())o[a.key]=a.valueConverter.fromJson(s[a.key]);return o}),t,r);return await r.resolveAll(),n}async _loadManyToOneForManyRows(e,t,r){var a;let n;t!=null&&t.load&&(n=t.load(this.metadata.fields));for(const l of this.metadata.fields)if(he(l.valueType,!1)&&!U(l)){let d=!l.options.lazy;if(n!==void 0&&(d=n.includes(l)),d){let p=this._remult.repo(l.valueType),y=[];for(const w of e){let k=w[l.key];k!=null&&!y.includes(k)&&!p._idCache.has(k+"")&&y.push(k)}y.length>0&&await s(p,y)}}async function s(l,f){let u=await l.find({where:l.metadata.idMetadata.getIdFilter(...f)},!0);for(const d of u)l._addToCache(d)}let o=await lt(e,async l=>await this._mapRawDataToResult(l,n));for(const l of this.metadata.fields){let f=U(l),u=l.options.defaultIncluded;if(((a=t==null?void 0:t.include)==null?void 0:a[l.key])!==void 0&&(u=t.include[l.key]),f&&u){const d=f.toRepo;for(const p of o){let{findOptions:y,returnNull:w}=this._findOptionsBasedOnRelation(f,l,u,p,d);if(w)p[l.key]=null;else{const k=f.toEntity,v=d;r.load({entityType:k,find:F=>v._rawFind(F,!1,r),metadata:v.metadata},y).then(F=>{F.length==0&&f.type=="toOne"||(p[l.key]=f.type!=="toMany"?F.length==0?null:F[0]:F)})}}}}return o}_findOptionsBasedOnRelation(e,t,r,n,s){let o=!1,a=!1,l=[],f={},u=[];typeof e.options.findOptions=="function"?u.push(e.options.findOptions(n)):typeof e.options.findOptions=="object"&&u.push(e.options.findOptions),typeof r=="object"&&u.push(r);for(const y of u){y.where&&l.push(y.where);for(const w of["limit","include","orderBy"])y[w]&&(f[w]=y[w])}const d=e.getFields(),p=y=>{let w=e.type==="reference"?j(n).fields.find(t.key).getId():n[y];return(e.type==="toOne"||e.type==="reference")&&(w===null?o=!0:w===void 0?a=!0:e.type==="reference"&&typeof w=="object"&&(w=s.metadata.idMetadata.getId(w))),w};d.compoundIdField&&(e.type==="toMany"?l.push({[d.compoundIdField]:this.metadata.idMetadata.getId(n)}):l.push(s.metadata.idMetadata.getIdFilter(p(d.compoundIdField))));for(const y in d.fields)Object.prototype.hasOwnProperty.call(d.fields,y)&&l.push({[y]:p(d.fields[y])});return f.where={$and:l},(e.type==="toOne"||e.type==="reference")&&f.orderBy&&(f.limit=1),{findOptions:f,returnNull:o,returnUndefined:a}}async _mapRawDataToResult(e,t){if(!e)return;let r=new this._entity(this._remult),n=new Ct(this._info,r,this,this._edp,this._remult,!1);return Object.defineProperty(r,Be,{get:()=>n}),await n.loadDataFrom(e,t),n.saveOriginalData(),r}toJson(e){return e==null?e:Array.isArray(e)?e.map(t=>this.toJson(t)):typeof e.then=="function"?e.then(t=>this.toJson(t)):this.getEntityRef(e).toApiJson(!0)}fromJson(e,t){if(e==null)return e;if(Array.isArray(e))return e.map(n=>this.fromJson(n,t));let r=new this._entity(this._remult);for(const n of this._fieldsOf(e))if(he(n.valueType,!1)){let o=e[n.key];typeof o=="string"||typeof o=="number"?r[n.key]=o:r[n.key]=this._remult.repo(n.valueType).fromJson(o)}else e[n.key]!==void 0&&(r[n.key]=n.valueConverter.fromJson(e[n.key]));if(this._fixTypes(r),t)return this.create(r);{let n=new Ct(this._info,r,this,this._edp,this._remult,!1);return Object.defineProperty(r,Be,{get:()=>n}),n.saveOriginalData(),r}}async count(e){return this._edp.count(await this._translateWhereToFilter(e))}async deleteMany({where:e}){if(A.throwErrorIfFilterIsEmpty(e,"deleteMany"),this._dataProvider.isProxy)return this._edp.deleteMany(await this._translateWhereToFilter(e));{let t=0;for await(const r of this.query({where:e}))await j(r).delete(),t++;return t}}async findOne(e,t=!1){let r,n;if(e||(e={}),e.useCache){let s=Sr(e,this.metadata),o=JSON.stringify(s);if(n=this._cache.get(o),n!==void 0)if(n.value&&this.getEntityRef(n.value).wasDeleted())n=void 0,this._cache.delete(o);else return this._cache.get(o).promise;else n={value:void 0,promise:void 0},this._cache.set(o,n)}return r=this.find({...e,limit:1},t).then(async s=>{let o;return s.length>0&&(o=s[0]),!o&&e.createIfNotFound&&(o=this.create(),e.where&&await ri(this.metadata,e.where,o)),o}),n&&(n.promise=r=r.then(s=>(n.value=s,s))),r}async findFirst(e,t,r=!1){if(t||(t={}),e)if(t.where){let n=t.where;t.where={$and:[n,e]}}else t.where=e;return this.findOne(t,r)}_fieldsOf(e){let t=Object.keys(e);return this.metadata.fields.toArray().filter(r=>t.includes(r.key))}create(e){var r;let t=new this._entity(this._remult);if(e){for(const n of this._fieldsOf(e))t[n.key]=e[n.key];this._fixTypes(t)}return(r=this._defaultFindOptions)!=null&&r.where&&(ri(this.metadata,this._defaultFindOptions.where,t),this._fixTypes(t)),this.getEntityRef(t),t}async _fixTypes(e){for(const t of this._fieldsOf(e)){const r=e[t.key];if(r!=null)if(t.valueType===Date&&!(r instanceof Date))e[t.key]=t.valueConverter.fromJson(t.valueConverter.toJson(r));else for(const[n,s]of[[String,"string"],[Number,"number"],[Boolean,"boolean"]])t.valueType===n&&typeof r!==s&&(e[t.key]=t.valueConverter.fromJson(t.valueConverter.toJson(r)))}return e}findId(e,t){if(e==null)return null;if(typeof e!="string"&&typeof e!="number")throw new Error("id can be either number or string, but got: "+typeof e);return this.findFirst({},{...t,where:this.metadata.idMetadata.getIdFilter(e)},!0)}async _translateWhereToFilter(e){var r,n;e||(e={}),(r=this._defaultFindOptions)!=null&&r.where&&(e={$and:[e,(n=this._defaultFindOptions)==null?void 0:n.where]}),this._dataProvider.isProxy||(this.metadata.options.backendPreprocessFilter&&(e=await this.metadata.options.backendPreprocessFilter(e,{metadata:this.metadata,getFilterPreciseValues:s=>A.getPreciseValues(this.metadata,s||e)})),this.metadata.options.backendPrefilter&&(e={$and:[e,await A.resolve(this.metadata.options.backendPrefilter)]}));let t=await A.fromEntityFilter(this.metadata,e);return t&&!this._dataProvider.isProxy&&(t=await A.translateCustomWhere(t,this.metadata,this._remult)),t}}function oo(i,e){let t=O.columnsOfType.get(i);t||O.columnsOfType.set(i,t=[]);let r=he(i)(e),n=Os(i),s=Object.getPrototypeOf(i);for(;s!=null;){let o=O.columnsOfType.get(s);o&&t.unshift(...o.filter(l=>!t.find(f=>f.key==l.key)));let a=he(s,!1);if(a){let l=a(e);r={...l,...r};let f=["saving","saved","deleting","deleted","validation"];for(const u of f)if(l[u]&&l[u]!==r[u]){let d=r[u];r[u]=async(p,y)=>{await d(p,y),await l[u](p,y)}}}s=Object.getPrototypeOf(s)}return new fo(Li(t,e),r,e,i,n)}class Ni{constructor(e,t,r,n){c(this,"fieldsMetadata");c(this,"instance");c(this,"remult");c(this,"isNewRow");c(this,"_error");c(this,"_subscribers");c(this,"_isLoading",!1);c(this,"lookups",new Map);c(this,"errors");c(this,"originalValues",{});var s;this.fieldsMetadata=e,this.instance=t,this.remult=r,this.isNewRow=n;{let o=r;o!=null&&o.iAmRemultProxy&&(r=O.remultFactory())}for(const o of e)if(he(o.valueType,!1)&&r){let l=new Ns(r.repo(o.valueType),!!U(o),o.allowNull);this.lookups.set(o.key,l);let f=t[o.key],u;Object.defineProperty(t,o.key,{get:()=>(this._subscribers&&(this._subscribers.reportObserved(),u||(u=this.fields.find(o.key),u._subscribers||(u._subscribers=new St)),u._subscribers.reportObserved()),l.item),set:d=>{var p;l.set(d),(p=this._subscribers)==null||p.reportChanged(),u||(u=this.fields.find(o.key),u._subscribers||(u._subscribers=new St)),u._subscribers.reportChanged()},enumerable:!0}),l.set(f)}else if(((s=U(o))==null?void 0:s.type)==="toOne"){let l=t.hasOwnProperty(o.key),f=t[o.key];n&&!f&&(l=!1),Object.defineProperty(t,o.key,{get:()=>f,set:u=>{if(f=u,u===void 0)return;const d=o.options;if(d.field&&(this.instance[d.field]=U(o).toRepo.metadata.idMetadata.getId(u)),d.fields){for(const p in d.fields)if(Object.prototype.hasOwnProperty.call(d.fields,p)){const y=d.fields[p];this.instance[y]=u==null?null:u[p]}}},enumerable:!0}),l&&(t[o.key]=f)}}get error(){var e;return(e=this._subscribers)==null||e.reportObserved(),this._error}set error(e){var t;this._error=e,(t=this._subscribers)==null||t.reportChanged()}subscribe(e){return this.initSubscribers(),this._subscribers.subscribe(e)}initSubscribers(){if(!this._subscribers){this._subscribers=new St;for(const e of this.fieldsMetadata){let t=he(e.valueType,!1),r=this.fields.find(e.key);if(r._subscribers=new St,!(t&&this.remult)){let n=this.instance[e.key];Object.defineProperty(this.instance,e.key,{get:()=>(this._subscribers.reportObserved(),r._subscribers.reportObserved(),n),set:s=>{n=s,this._subscribers.reportChanged(),r._subscribers.reportChanged()},enumerable:!0})}}}}get isLoading(){var e;return(e=this._subscribers)==null||e.reportObserved(),this._isLoading}set isLoading(e){var t;this._isLoading=e,(t=this._subscribers)==null||t.reportChanged()}async waitLoad(){await lt([...this.lookups.values()],e=>e.waitLoad())}__assertValidity(){if(!this.hasErrors())throw this.buildErrorInfoObject()}buildErrorInfoObject(){let e={modelState:Object.assign({},this.errors),message:this.error};if(!e.message){for(const t of this.fieldsMetadata)if(this.errors[t.key]){e.message=this.fields[t.key].metadata.caption+": "+this.errors[t.key],this.error=e.message;break}}return e}catchSaveErrors(e){let t=e;if(t instanceof Promise)return t.then(n=>this.catchSaveErrors(n));t.error&&(t=t.error),t.message?this.error=t.message:t.Message?this.error=t.Message:this.error=t;let r=t.modelState;throw r||(r=t.ModelState),r&&(this.errors=r),e}__clearErrorsAndReportChanged(){this.errors=void 0,this.error=void 0,this._reportChangedToEntityAndFields()}_reportChangedToEntityAndFields(){if(this._subscribers){this._subscribers.reportChanged();for(const e of this.fields)e._subscribers.reportChanged()}}hasErrors(){var e;return(e=this._subscribers)==null||e.reportObserved(),!this.error&&this.errors==null}copyDataToObject(e=!1){let t={};for(const r of this.fieldsMetadata){let n=this.lookups.get(r.key),s;const o=U(r);n?s=n.id:s=this.instance[r.key],o&&e&&!r.allowNull&&s==null&&(o.toRepo.metadata.idMetadata.field.valueType===Number?s=0:s=""),(!o||o.type==="reference")&&(s!==void 0&&(s=r.valueConverter.toJson(s),s!=null&&(s=r.valueConverter.fromJson(JSON.parse(JSON.stringify(s))))),t[r.key]=s)}return t}saveOriginalData(){this.originalValues=this.copyDataToObject(),this.saveMoreOriginalData()}saveMoreOriginalData(){}async validate(){if(this.__clearErrorsAndReportChanged(),await this.__performColumnAndEntityValidations(),this.hasErrors(),!this.hasErrors())return this.buildErrorInfoObject()}async __validateEntity(){this.__clearErrorsAndReportChanged(),await this.__performColumnAndEntityValidations(),this.__assertValidity()}async __performColumnAndEntityValidations(){}toApiJson(e=!1,t=!1){let r={};for(const n of this.fieldsMetadata)if(t||!this.remult||n.includedInApi(this.instance)){let s,o=this.lookups.get(n.key),a=!1;o?e?(s=o.toJson(),a=!0,r[n.key]=s):s=o.id:U(n)&&!e?a=!0:(s=this.instance[n.key],this.remult||s&&he(s.constructor,!1)&&(s=j(s).getId())),a||(r[n.key]=n.valueConverter.toJson(s))}return r}async _updateEntityBasedOnApi(e,t=!1){let r=Object.keys(e);for(const n of this.fieldsMetadata)if(r.includes(n.key)&&n.includedInApi(this.instance)&&(!this.remult||t||n.apiUpdateAllowed(this.instance))){let s=this.lookups.get(n.key);s?s.id=e[n.key]:this.instance[n.key]=n.valueConverter.fromJson(e[n.key])}await lt([...this.fields].filter(n=>!U(n.metadata)),n=>n.load())}}class Ct extends Ni{constructor(t,r,n,s,o,a){super(t.fieldsMetadata,r,o,a);c(this,"info");c(this,"repository");c(this,"edp");c(this,"_isNew");c(this,"metadata");c(this,"_wasDeleted",!1);c(this,"_columns");c(this,"_saving",!1);c(this,"id");c(this,"originalId");if(this.info=t,this.repository=n,this.edp=s,this._isNew=a,this.metadata=t,a)for(const l of t.fieldsMetadata)l.options.defaultValue&&r[l.key]===void 0&&(typeof l.options.defaultValue=="function"?r[l.key]=l.options.defaultValue(r):r[l.key]||(r[l.key]=l.options.defaultValue));this.info.options.entityRefInit&&this.info.options.entityRefInit(this,r),ve.entityRefInit&&ve.entityRefInit(this,r)}clone(){const t=this.toApiJson(!0,!0);return this.repository.fromJson(t,this.isNew())}get relations(){return this.repository.relations(this.instance)}get apiUpdateAllowed(){return this.remult.isAllowedForInstance(this.instance,this.metadata.options.allowApiUpdate)}get apiDeleteAllowed(){return this.remult.isAllowedForInstance(this.instance,this.metadata.options.allowApiDelete)}get apiInsertAllowed(){return this.remult.isAllowedForInstance(this.instance,this.metadata.options.allowApiInsert)}getId(){const t=r=>{let n=this.lookups.get(r.key);return n?n.id:this.instance[r.key]};return this.metadata.idMetadata.field instanceof qe?this.metadata.idMetadata.field.getId(t):t(this.metadata.idMetadata.field)}saveMoreOriginalData(){this.originalId=this.getId()}wasDeleted(){var t;return(t=this._subscribers)==null||t.reportObserved(),this._wasDeleted}undoChanges(){this.loadDataFrom(this.originalValues),this.__clearErrorsAndReportChanged()}async reload(){return await this.edp.find({where:await this.getIdFilter()}).then(async t=>{if(t.length===0)throw this.repository._notFoundError(this.id);await this.loadDataFrom(t[0]),this.saveOriginalData()}),this._reportChangedToEntityAndFields(),this.instance}get fields(){if(!this._columns){let t=[],r={find:n=>r[typeof n=="string"?n:n.key],[Symbol.iterator]:()=>t[Symbol.iterator](),toArray:()=>t};for(const n of this.info.fieldsMetadata)t.push(r[n.key]=new Bt(n.options,n,this.instance,this,this));this._columns=r}return this._columns}async save(t){var r;try{if(this._saving)throw new Error("cannot save while entity is already saving");if(this._saving=!0,this.wasDeleted())throw new Error("cannot save a deleted row");this.isLoading=!0,t===void 0&&await this.__validateEntity();let n=!1,s=this.buildLifeCycleEvent(()=>n=!0);if(!this.repository._dataProvider.isProxy){for(const u of this.fields)u.metadata.options.saving&&await u.metadata.options.saving(this.instance,u,s);this.info.entityInfo.saving&&await this.info.entityInfo.saving(this.instance,s)}this.__assertValidity();let o=this.copyDataToObject(this.isNew()),a=[];for(const u of this.metadata.fields)if(u.dbReadOnly||t!==void 0&&!t.includes(u.key)){o[u.key]=void 0,a.push(u.key);let d=this.fields.find(u);d.value=d.originalValue}let l,f=this.isNew();try{if((r=this._subscribers)==null||r.reportChanged(),this.isNew())l=await this.edp.insert(o);else{let u={},d=!1;for(const p in o)if(Object.prototype.hasOwnProperty.call(o,p)){const y=o[p];this.fields.find(p).valueChanged()&&!a.includes(p)&&(u[p]=y,d=!0)}if(!d)return this.instance;n?l=(await this.edp.find({where:await this.getIdFilter()}))[0]:l=await this.edp.update(this.id,u)}if(await this.loadDataFrom(l),s.id=this.getId(),!this.repository._dataProvider.isProxy&&(this.info.entityInfo.saved&&await this.info.entityInfo.saved(this.instance,s),this.repository.listeners))for(const u of this.repository.listeners.filter(d=>d.saved))await u.saved(this.instance,f);return await this.repository._remult.liveQueryPublisher.itemChanged(this.repository.metadata.key,[{id:this.getId(),oldId:this.getOriginalId(),deleted:!1}]),this.saveOriginalData(),this._isNew=!1,this.instance}catch(u){await this.catchSaveErrors(u)}}finally{this.isLoading=!1,this._reportChangedToEntityAndFields(),this._saving=!1}}async processInsertResponseDto(t){return await this.loadDataFrom(t),this.saveOriginalData(),this._isNew=!1,this.instance}async buildDtoForInsert(){await this.__validateEntity(),this.__assertValidity();let t=this.copyDataToObject(this.isNew()),r=[];for(const n of this.metadata.fields)if(n.dbReadOnly){t[n.key]=void 0,r.push(n.key);let s=this.fields.find(n);s.value=s.originalValue}return t}buildLifeCycleEvent(t=()=>{}){const r=this;return{isNew:r.isNew(),fields:r.fields,id:r.getId(),originalId:r.getOriginalId(),metadata:r.repository.metadata,repository:r.repository,preventDefault:()=>t(),relations:r.repository.relations(r.instance)}}async getIdFilter(){return await this.repository._translateWhereToFilter(this.repository.metadata.idMetadata.getIdFilter(this.id))}async delete(){this.__clearErrorsAndReportChanged();let t=!0,r=this.buildLifeCycleEvent(()=>t=!1);this.repository._dataProvider.isProxy||this.info.entityInfo.deleting&&await this.info.entityInfo.deleting(this.instance,r),this.__assertValidity();try{if(t&&await this.edp.delete(this.id),this.repository._dataProvider.isProxy||this.info.entityInfo.deleted&&await this.info.entityInfo.deleted(this.instance,r),this.repository.listeners)for(const n of this.repository.listeners.filter(s=>s.deleted))await n.deleted(this.instance);await this.repository._remult.liveQueryPublisher.itemChanged(this.repository.metadata.key,[{id:this.getId(),oldId:this.getOriginalId(),deleted:!0}]),this._wasDeleted=!0}catch(n){await this.catchSaveErrors(n)}}async loadDataFrom(t,r){for(const n of this.info.fields){let s=this.lookups.get(n.key);s?(s.id=t[n.key],r===void 0?!n.options.lazy&&!U(n)&&await s.waitLoad():r.includes(n)&&await s.waitLoad()):U(n)||(this.instance[n.key]=t[n.key])}await this.calcServerExpression(),this.id=this.getId()}getOriginalId(){return this.originalId}async calcServerExpression(){if(dr())for(const t of this.info.fieldsMetadata)t.options.serverExpression&&(this.instance[t.key]=await t.options.serverExpression(this.instance))}isNew(){var t;return(t=this._subscribers)==null||t.reportObserved(),this._isNew}wasChanged(){var t;(t=this._subscribers)==null||t.reportObserved();for(const r of this.fields){const n=U(r.metadata);if((!n||n.type=="reference")&&r.valueChanged())return!0}return!1}async __performColumnAndEntityValidations(){for(const t of this.fieldsMetadata)t.options.validate&&await new Bt(t.options,t,this.instance,this,this).__performValidation();if(this.info.entityInfo.validation){let t=this.buildLifeCycleEvent(()=>{});await this.info.entityInfo.validation(this.instance,t)}if(this.repository.listeners)for(const t of this.repository.listeners.filter(r=>r.validating))await t.validating(this.instance)}}const ni=Symbol.for("controllerColumns");function Li(i,e){return i.map(t=>Fr(t.settings(e),e))}function si(i,e){const t=e||ye;let r=i[ni];if(r||(r=i[Be]),!r){let n=O.columnsOfType.get(i.constructor);n||O.columnsOfType.set(i.constructor,n=[]);let s=Object.getPrototypeOf(i.constructor);for(;s!=null;){let o=O.columnsOfType.get(s);o&&n.unshift(...o.filter(a=>!n.find(l=>l.key==a.key))),s=Object.getPrototypeOf(s)}i[ni]=r=new ao(Li(n,t).map(o=>new qi(o,void 0,t)),i,t)}return r}class ao extends Ni{constructor(t,r,n){super(t,r,n,!1);c(this,"fields");let s=[],o={find:a=>o[typeof a=="string"?a:a.key],[Symbol.iterator]:()=>s[Symbol.iterator](),toArray:()=>s};for(const a of t)s.push(o[a.key]=new Bt(a.options,a,r,void 0,this));this.fields=o}async __performColumnAndEntityValidations(){for(const t of this.fields)t instanceof Bt&&await t.__performValidation()}}class Bt{constructor(e,t,r,n,s){c(this,"settings");c(this,"metadata");c(this,"container");c(this,"helper");c(this,"rowBase");c(this,"_subscribers");c(this,"target");c(this,"entityRef");this.settings=e,this.metadata=t,this.container=r,this.helper=n,this.rowBase=s,this.target=this.settings.target,this.entityRef=this.helper}subscribe(e){return this._subscribers||this.rowBase.initSubscribers(),this._subscribers.subscribe(e)}valueIsNull(){this.reportObserved();let e=this.rowBase.lookups.get(this.metadata.key);return e?e.id===void 0||e.id===null:this.value===null}originalValueIsNull(){return this.reportObserved(),this.rowBase.lookups.get(this.metadata.key),this.rawOriginalValue()===null}async load(){let e=this.rowBase.lookups.get(this.metadata.key),t=U(this.metadata);if(t){if(t.type==="toMany")return this.container[this.metadata.key]=await this.helper.repository.relations(this.container)[this.metadata.key].find();{let r=await this.helper.repository.relations(this.container)[this.metadata.key].findOne();if(r)this.container[this.metadata.key]=r;else return null}}else if(e)return this.valueChanged()&&await e.waitLoadOf(this.rawOriginalValue()),await e.waitLoad();return this.value}reportObserved(){var e,t;(e=this._subscribers)==null||e.reportObserved(),(t=this.rowBase._subscribers)==null||t.reportObserved()}reportChanged(){var e,t;(e=this._subscribers)==null||e.reportChanged(),(t=this.rowBase._subscribers)==null||t.reportChanged()}get error(){if(this.reportObserved(),!!this.rowBase.errors)return this.rowBase.errors[this.metadata.key]}set error(e){this.rowBase.errors||(this.rowBase.errors={}),this.rowBase.errors[this.metadata.key]=e,this.reportChanged()}get displayValue(){return this.reportObserved(),this.value!=null?this.settings.displayValue?this.settings.displayValue(this.container,this.value):this.metadata.valueConverter.displayValue?this.metadata.valueConverter.displayValue(this.value):this.value.toString():""}get value(){return this.container[this.metadata.key]}set value(e){this.container[this.metadata.key]=e}get originalValue(){this.reportObserved();let e=this.rowBase.lookups.get(this.metadata.key);return e?e.get(this.rawOriginalValue()):this.rowBase.originalValues[this.metadata.key]}rawOriginalValue(){return this.rowBase.originalValues[this.metadata.key]}setId(e){this.value=e}getId(){let e=this.rowBase.lookups.get(this.metadata.key);return e?e.id!=null?e.id:null:this.value}get inputValue(){this.reportObserved();let e=this.rowBase.lookups.get(this.metadata.key);return e?e.id!=null?e.id.toString():null:this.metadata.valueConverter.toInput(this.value,this.settings.inputType)}set inputValue(e){let t=this.rowBase.lookups.get(this.metadata.key);t?t.setId(e):this.value=this.metadata.valueConverter.fromInput(e,this.settings.inputType)}valueChanged(){this.reportObserved();let e=this.value,t=this.rowBase.lookups.get(this.metadata.key);return t&&(e=t.id),JSON.stringify(this.metadata.valueConverter.toJson(this.rowBase.originalValues[this.metadata.key]))!=JSON.stringify(this.metadata.valueConverter.toJson(e))}async __performValidation(){var e;try{const t=r=>{r!==!0&&r!==void 0&&!this.error&&(typeof r=="string"&&r.length>0?this.error=r:this.error="invalid value")};if(this.settings.validate){let r=this,n={entityRef:this.entityRef,get error(){return r.error},set error(s){r.error=s},isNew:(e=this.entityRef)==null?void 0:e.isNew(),load:()=>r.load(),metadata:r.metadata,originalValue:r.originalValue,value:r.value,valueChanged:()=>r.valueChanged(),originalValueIsNull:()=>r.originalValueIsNull(),valueIsNull:()=>r.valueIsNull(),isBackend:()=>{var s,o,a;return!((a=(o=(s=r.rowBase)==null?void 0:s.remult)==null?void 0:o.dataProvider)!=null&&a.isProxy)}};if(Array.isArray(this.settings.validate))for(const s of this.settings.validate)t(await s(this.container,n));else typeof this.settings.validate=="function"&&t(await this.settings.validate(this.container,n))}}catch(t){typeof t=="string"?this.error=t:this.error=t.message}}async validate(){return await this.__performValidation(),!this.error}}let lo={transformCaption:(i,e,t,r)=>t};const uo=O.captionTransformer||(O.captionTransformer=lo);function Bi(i,e,t,r){let n;return typeof i=="function"?t&&(n=i(t)):i&&(n=i),n=uo.transformCaption(t,e,n,r),n||(e?Ms(e):"")}class qi{constructor(e,t,r){c(this,"settings");c(this,"entityDefs");c(this,"remult");c(this,"options");c(this,"target");c(this,"readonly");c(this,"valueConverter");c(this,"allowNull");c(this,"caption");c(this,"dbName");c(this,"inputType");c(this,"key");c(this,"isServerExpression");c(this,"valueType");this.settings=e,this.entityDefs=t,this.remult=r,this.options=this.settings,this.target=this.settings.target,this.valueConverter=new Proxy(this.settings.valueConverter,{get:(n,s)=>{let o=n[s];return typeof o=="function"?(...a)=>{try{return n[s](...a)}catch(l){const f=`${String(s)} failed for value ${a==null?void 0:a[0]}. Error: ${typeof l=="string"?l:l.message}`;throw{message:this.caption+": "+f,modelState:{[this.key]:f}}}}:o}}),this.allowNull=!!this.settings.allowNull,this.valueType=this.settings.valueType,this.key=this.settings.key,this.inputType=this.settings.inputType,e.serverExpression&&(this.isServerExpression=!0),typeof this.settings.allowApiUpdate=="boolean"&&(this.readonly=this.settings.allowApiUpdate),this.inputType||(this.inputType=this.valueConverter.inputType),this.dbName=e.dbName,this.dbName==null&&(this.dbName=e.key),this.caption=Bi(e.caption,e.key,r,t)}apiUpdateAllowed(e){return this.options.allowApiUpdate===void 0?!0:this.remult.isAllowedForInstance(e,this.options.allowApiUpdate)}displayValue(e){return this.entityDefs.getEntityMetadataWithoutBreakingTheEntity(e).fields.find(this.key).displayValue}includedInApi(e){return this.options.includeInApi===void 0?!0:this.remult.isAllowedForInstance(e,this.options.includeInApi)}toInput(e,t){return this.valueConverter.toInput(e,t)}fromInput(e,t){return this.valueConverter.fromInput(e,t)}async getDbName(){return Pr(this,this.entityDefs)}get dbReadOnly(){return this.settings.dbReadOnly}}class fo{constructor(e,t,r,n,s){c(this,"entityInfo");c(this,"remult");c(this,"entityType");c(this,"key");c(this,"options");c(this,"fieldsMetadata",[]);c(this,"idMetadata",{getId:e=>{if(e==null)return e;const t=j(e,!1);return t?t.getId():this.idMetadata.field instanceof qe?this.idMetadata.field.getId(e):e[this.idMetadata.field.key]},field:void 0,get fields(){return this.field instanceof qe?this.field.fields:[this.field]},createIdInFilter:e=>{if(e.length>0)return{$or:e.map(t=>this.idMetadata.getIdFilter(j(t).getId()))}},isIdField:e=>e.key==this.idMetadata.field.key,getIdFilter:(...e)=>{if(this.idMetadata.field instanceof qe){let t=this.idMetadata.field;return e.length==1?t.isEqualTo(e[0]):{$or:e.map(r=>t.isEqualTo(r))}}return e.length==1?{[this.idMetadata.field.key]:e[0]}:{[this.idMetadata.field.key]:e}}});c(this,"fields");c(this,"dbName");c(this,"caption");if(this.entityInfo=t,this.remult=r,this.entityType=n,this.key=s,this.options=t,this.options.allowApiCrud!==void 0){let a;typeof this.options.allowApiCrud=="function"?a=(l,f)=>this.options.allowApiCrud(f):a=this.options.allowApiCrud,this.options.allowApiDelete===void 0&&(this.options.allowApiDelete=a),this.options.allowApiInsert===void 0&&(this.options.allowApiInsert=a),this.options.allowApiUpdate===void 0&&(this.options.allowApiUpdate=a),this.options.allowApiRead===void 0&&(this.options.allowApiRead=this.options.allowApiCrud)}this.options.allowApiRead===void 0&&(this.options.allowApiRead=!0),this.key||(this.key=n.name),t.dbName||(t.dbName=this.key),this.dbName=t.dbName;let o={find:a=>o[typeof a=="string"?a:a.key],[Symbol.iterator]:()=>this.fieldsMetadata[Symbol.iterator](),toArray:()=>this.fieldsMetadata};for(const a of e)this.fieldsMetadata.push(o[a.key]=new qi(a,this,r));if(this.fields=o,this.caption=Bi(t.caption,this.key,r,this),t.id){let a=typeof t.id=="function"?t.id(this.fields):Object.keys(t.id).map(l=>this.fields.find(l));Array.isArray(a)?a.length>1?this.idMetadata.field=new qe(...a):a.length==1&&(this.idMetadata.field=a[0]):this.idMetadata.field=a}this.idMetadata.field||(this.fields.id?this.idMetadata.field=this.fields.id:this.idMetadata.field=[...this.fields][0])}apiUpdateAllowed(e){return this.options.allowApiUpdate===void 0?!1:e?this.getEntityMetadataWithoutBreakingTheEntity(e).apiUpdateAllowed:this.remult.isAllowedForInstance(void 0,this.options.allowApiUpdate)}get apiReadAllowed(){return this.options.allowApiRead===void 0?!0:this.remult.isAllowed(this.options.allowApiRead)}apiDeleteAllowed(e){return this.options.allowApiDelete===void 0?!1:e?this.getEntityMetadataWithoutBreakingTheEntity(e).apiDeleteAllowed:this.remult.isAllowedForInstance(void 0,this.options.allowApiDelete)}apiInsertAllowed(e){return this.options.allowApiUpdate===void 0?!1:e?this.getEntityMetadataWithoutBreakingTheEntity(e).apiInsertAllowed:this.remult.isAllowedForInstance(void 0,this.options.allowApiInsert)}getEntityMetadataWithoutBreakingTheEntity(e){let t=j(e,!1);return t||this.remult.repo(this.entityType).getEntityRef({...e})}getDbName(){return Vi(this)}}function co(i){var e,t;return((t=(e=i.options)==null?void 0:e.valueConverter)==null?void 0:t.fieldTypeInDb)==="autoincrement"}const ho=Symbol.for("storableMember"),tr=Symbol.for("fieldOptionalValues");function ji(i,e){let t={};for(const r of i)if(r)if(typeof r=="function")r(t,e);else{const{validate:n,...s}=r;t.validate=Dt(t.validate,n),Object.assign(t,s)}return t}function Fr(i,e){if(i.valueType){let t=i.valueType[ho];t&&(i=ji([...t,i],e))}if(i.valueType==String){let t=i;i.valueConverter||(t.valueConverter=ae.String)}if(i.valueType==Number){let t=i;i.valueConverter||(t.valueConverter=ae.Number)}if(i.valueType==Date){let t=i;i.valueConverter||(t.valueConverter=ae.Date)}if(i.valueType==Boolean){let t=i;t.valueConverter||(t.valueConverter=ae.Boolean)}if(!i.valueConverter){if(he(i.valueType,!1)){let r;i.valueConverter={toDb:n=>n,fromDb:n=>n},i.valueConverter=new Proxy(i.valueConverter,{get(n,s){if(n[s]===void 0&&r===void 0){if(s==="inputType")return"";r=e.repo(i.valueType).metadata.idMetadata.field.valueType===Number;for(const o of["fieldTypeInDb","toJson","fromJson","toDb","fromDb"])n[o]=r?ae.Integer[o]:ae.String[o]}return n[s]},set(n,s,o,a){return n[s]=o,!0}})}else i.valueConverter=ae.Default;return i}return i.valueConverter.toJson||(i.valueConverter.toJson=t=>t),i.valueConverter.fromJson||(i.valueConverter.fromJson=t=>t),i.valueConverter.toDb||(i.valueConverter.toDb=t=>i.valueConverter.toJson(t)),i.valueConverter.fromDb||(i.valueConverter.fromDb=t=>i.valueConverter.fromJson(t)),i.valueConverter.toInput||(i.valueConverter.toInput=t=>i.valueConverter.toJson(t)),i.valueConverter.fromInput||(i.valueConverter.fromInput=t=>i.valueConverter.fromJson(t)),i}class Ji{get _(){return j(this)}save(){return j(this).save()}assign(e){return hr(this,e),this}delete(){return this._.delete()}isNew(){return this._.isNew()}get $(){return this._.fields}}class po{constructor(e,t){c(this,"options");c(this,"repo");c(this,"_count");this.options=e,this.repo=t,this.options||(this.options={}),this.options.pageSize||(this.options.pageSize=eo.defaultPageSize)}async getPage(e){return e<1&&(e=1),this.repo.find({where:this.options.where,orderBy:this.options.orderBy,limit:this.options.pageSize,page:e,load:this.options.load,include:this.options.include})}async count(){return this._count===void 0&&(this._count=await this.repo.count(this.options.where)),this._count}async forEach(e){let t=0;for await(const r of this)await e(r),t++;return t}async paginator(e){this.options.orderBy=ce.createUniqueEntityOrderBy(this.repo.metadata,this.options.orderBy);let t=await this.repo.find({where:{$and:[this.options.where,e]},orderBy:this.options.orderBy,limit:this.options.pageSize,load:this.options.load,include:this.options.include}),r,n=t.length==this.options.pageSize;if(n){let s=await this.repo._createAfterFilter(this.options.orderBy,t[t.length-1]);r=()=>this.paginator(s)}return{count:()=>this.count(),hasNextPage:n,items:t,nextPage:r}}[Symbol.asyncIterator](){this.options.where||(this.options.where={});let e=this.options.orderBy;this.options.orderBy=ce.createUniqueEntityOrderBy(this.repo.metadata,e);let t=-1,r,n,s=0;return n=async()=>{if(this.options.progress&&this.options.progress.progress(s++/await this.count()),r===void 0||t==r.items.length){if(r&&!r.hasNextPage)return{value:void 0,done:!0};let o=r;if(r?r=await r.nextPage():r=await this.paginator(),t=0,r.items.length==0)return{value:void 0,done:!0};if((o==null?void 0:o.items.length)>0&&this.repo.getEntityRef(o.items[0]).getId()==this.repo.getEntityRef(r.items[0]).getId())throw new Error("pagination failure, returned same first row")}if(t<r.items.length)return{value:r.items[t++],done:!1}},{next:async()=>n()}}}class St{constructor(){c(this,"_subscribers")}reportChanged(){this._subscribers&&this._subscribers.forEach(e=>e.reportChanged())}reportObserved(){this._subscribers&&this._subscribers.forEach(e=>e.reportObserved())}subscribe(e){let t;return typeof e=="function"?t={reportChanged:()=>e(),reportObserved:()=>{}}:t=e,this._subscribers||(this._subscribers=[]),this._subscribers.push(t),()=>this._subscribers=this._subscribers.filter(r=>r!=t)}}function yo(i){return i.metadata?i.metadata:he(i,!1)?ye.repo(i).metadata:i}function mo(i){return he(i,!1)?ye.repo(i):i}async function lt(i,e){const t=[];for(let r=0;r<i.length;r++){const n=i[r];t.push(await e(n,r))}return t}const Ge=class Ge{constructor(e){c(this,"sql");c(this,"wrapIdentifier",e=>e);c(this,"provideMigrationBuilder");c(this,"createdEntities",[]);c(this,"end");this.sql=e,e.wrapIdentifier&&(this.wrapIdentifier=t=>e.wrapIdentifier(t)),er(e,"provideMigrationBuilder")&&(this.provideMigrationBuilder=t=>e.provideMigrationBuilder(t)),er(e,"end")&&(this.end=()=>e.end())}static getDb(e){const t=e||ye.dataProvider;if(er(t,"createCommand"))return t;throw"the data provider is not an SqlCommandFactory"}createCommand(){return new go(this.sql.createCommand(),Ge.LogToConsole)}async execute(e){return await this.createCommand().execute(e)}_getSourceSql(){return this.sql}async ensureSchema(e){this.sql.ensureSchema&&await this.sql.ensureSchema(e)}getEntityDataProvider(e){if(!this.sql.supportsJsonColumnType)for(const t of e.fields.toArray())t.valueConverter.fieldTypeInDb==="json"&&(t.valueConverter={...t.valueConverter,toDb:ae.JsonString.toDb,fromDb:ae.JsonString.fromDb});return new Ui(e,this,async t=>{this.createdEntities.indexOf(t.$entityName)<0&&(this.createdEntities.push(t.$entityName),await this.sql.entityIsUsedForTheFirstTime(e))},this.sql)}transaction(e){return this.sql.transaction(async t=>{let r=!1;try{await e(new Ge({createCommand:()=>{let n=t.createCommand();return{addParameterAndReturnSqlToken:s=>n.param(s),param:s=>n.param(s),execute:async s=>{if(r)throw"can't run a command after the transaction was completed";return n.execute(s)}}},getLimitSqlSyntax:this.sql.getLimitSqlSyntax,entityIsUsedForTheFirstTime:n=>t.entityIsUsedForTheFirstTime(n),transaction:n=>t.transaction(n),supportsJsonColumnType:this.sql.supportsJsonColumnType,wrapIdentifier:this.wrapIdentifier,end:this.end}))}finally{r=!0}})}static rawFilter(e){return{[Ti]:{buildSql:e}}}static async filterToRaw(e,t,r,n,s){r||(r=new bo);const o=mo(e);var a=new je(r,n||await xi(o.metadata,s));return a._addWhere=!1,await(await Ue(o)._translateWhereToFilter(t)).__applyToConsumer(a),await a.resolveWhere()}};c(Ge,"LogToConsole",!1),c(Ge,"durationThreshold",0);let Xe=Ge;const wo=new Map([["INSERT",""],["SELECT",""],["UPDATE",""],["DELETE",""],["CREATE",""],["ALTER",""],["DROP",""],["TRUNCATE",""],["GRANT",""],["REVOKE",""]]);class go{constructor(e,t){c(this,"origin");c(this,"logToConsole");c(this,"args",{});this.origin=e,this.logToConsole=t}addParameterAndReturnSqlToken(e){return this.param(e)}param(e,t){let r=this.origin.param(e);return this.args[r]=e,r}async execute(e){try{let r=new Date,n=await this.origin.execute(e);if(this.logToConsole!==!1){var t=new Date().valueOf()-r.valueOf();if(t>Xe.durationThreshold){const s=t/1e3;if(this.logToConsole==="oneLiner"){const o=e.replace(/(\r\n|\n|\r|\t)/gm," ").replace(/  +/g," ").trim(),a=o.split(" ")[0].toUpperCase();console.info(`${wo.get(a)||""} (${s.toFixed(3)}) ${o} ${JSON.stringify(this.args)}`)}else typeof this.logToConsole=="function"?this.logToConsole(s,e,this.args):console.info(e+`
`,{arguments:this.args,duration:s})}}return n}catch(r){throw console.error((r.message||"Sql Error")+`:
`,e,{arguments:this.args,error:r}),r}}}class Ui{constructor(e,t,r,n){c(this,"entity");c(this,"sql");c(this,"iAmUsed");c(this,"strategy");this.entity=e,this.sql=t,this.iAmUsed=r,this.strategy=n}async init(){let e=await xi(this.entity,t=>this.sql.wrapIdentifier(t));return await this.iAmUsed(e),e}async count(e){let t=await this.init(),r="select count(*) count from "+t.$entityName,n=this.sql.createCommand();if(e){let s=new je(n,t);e.__applyToConsumer(s),r+=await s.resolveWhere()}return n.execute(r).then(s=>Number(s.rows[0].count))}async find(e){let t=await this.init(),{colKeys:r,select:n}=this.buildSelect(t);n="select "+n,n+=`
 from `+t.$entityName;let s=this.sql.createCommand();if(e){if(e.where){let o=new je(s,t);e.where.__applyToConsumer(o),n+=await o.resolveWhere()}if(e.limit&&(e.orderBy=ce.createUniqueSort(this.entity,e.orderBy)),e.orderBy||(e.orderBy=ce.createUniqueSort(this.entity,new ce)),e.orderBy){let o=!0,a=[];for(const l of e.orderBy.Segments)a.push(l);for(const l of a)o?(n+=" Order By ",o=!1):n+=", ",n+=t.$dbNameOf(l.field),l.isDescending&&(n+=" desc"),this.sql._getSourceSql().orderByNullsFirst&&(l.isDescending?n+=" nulls last":n+=" nulls first")}if(e.limit){let o=1;e.page&&(o=e.page),o<1&&(o=1),n+=" "+this.strategy.getLimitSqlSyntax(e.limit,(o-1)*e.limit)}}return s.execute(n).then(o=>o.rows.map(a=>this.buildResultRow(r,a,o)))}buildResultRow(e,t,r){let n={};for(let s=0;s<e.length;s++){const o=e[s];try{n[o.key]=o.valueConverter.fromDb(t[r.getColumnKeyInResultForIndexInSelect(s)])}catch(a){throw new Error("Failed to load from db:"+o.key+`\r
`+a)}}return n}buildSelect(e){let t="",r=[];for(const n of this.entity.fields)n.isServerExpression||(r.length>0&&(t+=", "),t+=e.$dbNameOf(n),r.push(n));return{colKeys:r,select:t}}async update(e,t){let r=await this.init(),n=this.sql.createCommand(),s="update "+r.$entityName+" set ",o=!1;for(const d of this.entity.fields)if(!ai(d,r)){if(t[d.key]!==void 0){let p=d.valueConverter.toDb(t[d.key]);p!==void 0&&(o?s+=", ":o=!0,s+=r.$dbNameOf(d)+" = "+n.param(p))}}const a=this.entity.idMetadata.getIdFilter(e);let l=new je(n,r);A.fromEntityFilter(this.entity,a).__applyToConsumer(l),s+=await l.resolveWhere();let{colKeys:f,select:u}=this.buildSelect(r);return this.sql._getSourceSql().doesNotSupportReturningSyntax||(s+=" returning "+u),n.execute(s).then(d=>{var p,y;if((y=(p=this.sql._getSourceSql()).afterMutation)==null||y.call(p),this.sql._getSourceSql().doesNotSupportReturningSyntax)return oi(this.entity,this,t,e,"update");if(d.rows.length!=1)throw new Error("Failed to update row with id "+e+", rows updated: "+d.rows.length);return this.buildResultRow(f,d.rows[0],d)})}async delete(e){let t=await this.init(),r=this.sql.createCommand(),n=new je(r,t);A.fromEntityFilter(this.entity,this.entity.idMetadata.getIdFilter(e)).__applyToConsumer(n);let s="delete from "+t.$entityName;return s+=await n.resolveWhere(),r.execute(s).then(()=>{var o,a;(a=(o=this.sql._getSourceSql()).afterMutation)==null||a.call(o)})}async insert(e){let t=await this.init(),r=this.sql.createCommand(),n="",s="",o=!1;for(const u of this.entity.fields)if(!ai(u,t)){let d=u.valueConverter.toDb(e[u.key]);d!=null&&(o?(n+=", ",s+=", "):o=!0,n+=t.$dbNameOf(u),s+=r.param(d))}let a=`insert into ${t.$entityName} (${n}) values (${s})`,{colKeys:l,select:f}=this.buildSelect(t);return this.sql._getSourceSql().doesNotSupportReturningSyntax||(a+=" returning "+f),await r.execute(a).then(u=>{var d,p;if((p=(d=this.sql._getSourceSql()).afterMutation)==null||p.call(d),this.sql._getSourceSql().doesNotSupportReturningSyntax)if(co(this.entity.idMetadata.field)){const y=u.rows[0];if(typeof y!="number")throw new Error("Auto increment, for a database that is does not support returning syntax, should return an array with the single last added id. Instead it returned: "+JSON.stringify(y));return this.find({where:new A(w=>w.isEqualTo(this.entity.idMetadata.field,y))}).then(w=>w[0])}else return oi(this.entity,this,e,void 0,"insert");return this.buildResultRow(l,u.rows[0],u)})}}c(Ui,"LogToConsole",!1);class bo{execute(e){throw new Error("Method not implemented.")}addParameterAndReturnSqlToken(e){return this.param(e)}param(e){return e===null?"null":(e instanceof Date&&(e=e.toISOString()),typeof e=="string"?(e==null&&(e=""),"'"+e.replace(/'/g,"''")+"'"):e.toString())}}function oi(i,e,t,r,n){const s=r!==void 0?i.idMetadata.getIdFilter(r):{};return e.find({where:new A(o=>{for(const a of i.idMetadata.fields)o.isEqualTo(a,t[a.key]??s[a.key])})}).then(o=>{if(o.length!=1)throw new Error(`Failed to ${n} row - result contained ${o.length} rows`);return o[0]})}class je{constructor(e,t){c(this,"r");c(this,"nameProvider");c(this,"where","");c(this,"_addWhere",!0);c(this,"promises",[]);this.r=e,this.nameProvider=t}async resolveWhere(){for(;this.promises.length>0;){let e=this.promises;this.promises=[];for(const t of e)await t}return this.where}custom(e,t){throw new Error("Custom filter should be translated before it gets here")}or(e){let t="";this.promises.push((async()=>{for(const r of e){let n=new je(this.r,this.nameProvider);n._addWhere=!1,r.__applyToConsumer(n);let s=await n.resolveWhere();if(!s)return;s.length>0&&(t.length>0&&(t+=" or "),e.length>1?t+="("+s+")":t+=s)}this.addToWhere("("+t+")")})())}isNull(e){this.promises.push((async()=>this.addToWhere(this.nameProvider.$dbNameOf(e)+" is null"))())}isNotNull(e){this.promises.push((async()=>this.addToWhere(this.nameProvider.$dbNameOf(e)+" is not null"))())}isIn(e,t){this.promises.push((async()=>{t&&t.length>0?this.addToWhere(this.nameProvider.$dbNameOf(e)+" in ("+t.map(r=>this.r.param(e.valueConverter.toDb(r))).join(",")+")"):this.addToWhere("1 = 0 /*isIn with no values*/")})())}isEqualTo(e,t){this.add(e,t,"=")}isDifferentFrom(e,t){this.add(e,t,"<>")}isGreaterOrEqualTo(e,t){this.add(e,t,">=")}isGreaterThan(e,t){this.add(e,t,">")}isLessOrEqualTo(e,t){this.add(e,t,"<=")}isLessThan(e,t){this.add(e,t,"<")}containsCaseInsensitive(e,t){this.promises.push((async()=>{this.addToWhere("lower ("+this.nameProvider.$dbNameOf(e)+") like lower ('%"+t.replace(/'/g,"''")+"%')")})())}notContainsCaseInsensitive(e,t){this.promises.push((async()=>{this.addToWhere("not lower ("+this.nameProvider.$dbNameOf(e)+") like lower ('%"+t.replace(/'/g,"''")+"%')")})())}add(e,t,r){this.promises.push((async()=>{let n=this.nameProvider.$dbNameOf(e)+" "+r+" "+this.r.param(e.valueConverter.toDb(t));this.addToWhere(n)})())}addToWhere(e){this.where.length==0?this._addWhere&&(this.where+=" where "):this.where+=" and ",this.where+=e}databaseCustom(e){this.promises.push((async()=>{if(e!=null&&e.buildSql){let t=new vo(this.r,this.nameProvider.wrapIdentifier),r=await e.buildSql(t);typeof r!="string"&&(r=t.sql),r&&this.addToWhere("("+r+")")}})())}}class vo{constructor(e,t){c(this,"r");c(this,"wrapIdentifier");c(this,"sql","");c(this,"param",(e,t)=>(typeof t=="object"&&t.valueConverter.toDb&&(e=t.valueConverter.toDb(e)),this.r.param(e)));c(this,"filterToRaw",async(e,t)=>Xe.filterToRaw(e,t,this,void 0,this.wrapIdentifier));this.r=e,this.wrapIdentifier=t,this.param.bind(this),this.filterToRaw.bind(this)}addParameterAndReturnSqlToken(e){return this.param(e)}}function ai(i,e){return i.dbReadOnly||i.isServerExpression||i.options.sqlExpression&&i.dbName!=e.$dbNameOf(i)}async function xi(i,e){let t=typeof e=="function"?{wrapIdentifier:e}:e||{};var r=yo(i);t.wrapIdentifier||(t.wrapIdentifier=ye.dataProvider.wrapIdentifier),t.wrapIdentifier||(t.wrapIdentifier=s=>s);const n={$entityName:await Vi(r,t.wrapIdentifier),toString:()=>n.$entityName,$dbNameOf:s=>{var o;return typeof s=="string"?o=s:o=s.key,n[o]},wrapIdentifier:t.wrapIdentifier};for(const s of r.fields){let o=await Pr(s,r,t.wrapIdentifier);s.options.sqlExpression||(typeof t.tableName=="string"?o=t.wrapIdentifier(t.tableName)+"."+o:t.tableName===!0&&(o=n.$entityName+"."+o)),n[s.key]=o}return n}async function Vi(i,e=t=>t){if(i.options.sqlExpression){if(typeof i.options.sqlExpression=="string")return i.options.sqlExpression;if(typeof i.options.sqlExpression=="function"){const t=i.options.sqlExpression;try{return i.options.sqlExpression="recursive sqlExpression call for entity '"+i.key+"'. ",await t(i)}finally{i.options.sqlExpression=t}}}return e(i.dbName)}async function Pr(i,e,t=r=>r){try{if(i.options.sqlExpression){let s;if(typeof i.options.sqlExpression=="function"){const o=i.options.sqlExpression;try{i.options.sqlExpression="recursive sqlExpression call for field '"+i.key+"'. ",s=await o(e),i.options.sqlExpression=()=>s}finally{}}else s=i.options.sqlExpression;return s||i.dbName}const r=U(i);let n=(r==null?void 0:r.type)==="toOne"&&i.options.field;if(n){let s=e.fields.find(n);if(s)return Pr(s,e,t)}return t(i.dbName)}finally{}}var qt=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},De={},B={},Z={};Object.defineProperty(Z,"__esModule",{value:!0});Z.output=Z.exists=Z.hash=Z.bytes=Z.bool=Z.number=Z.isBytes=void 0;function jt(i){if(!Number.isSafeInteger(i)||i<0)throw new Error(`positive integer expected, not ${i}`)}Z.number=jt;function Hi(i){if(typeof i!="boolean")throw new Error(`boolean expected, not ${i}`)}Z.bool=Hi;function Wi(i){return i instanceof Uint8Array||i!=null&&typeof i=="object"&&i.constructor.name==="Uint8Array"}Z.isBytes=Wi;function Rr(i,...e){if(!Wi(i))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(i.length))throw new Error(`Uint8Array expected of length ${e}, not of length=${i.length}`)}Z.bytes=Rr;function $i(i){if(typeof i!="function"||typeof i.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");jt(i.outputLen),jt(i.blockLen)}Z.hash=$i;function Ki(i,e=!0){if(i.destroyed)throw new Error("Hash instance has been destroyed");if(e&&i.finished)throw new Error("Hash#digest() has already been called")}Z.exists=Ki;function Qi(i,e){Rr(i);const t=e.outputLen;if(i.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}Z.output=Qi;const _o={number:jt,bool:Hi,bytes:Rr,hash:$i,exists:Ki,output:Qi};Z.default=_o;var S={};Object.defineProperty(S,"__esModule",{value:!0});S.add5L=S.add5H=S.add4H=S.add4L=S.add3H=S.add3L=S.add=S.rotlBL=S.rotlBH=S.rotlSL=S.rotlSH=S.rotr32L=S.rotr32H=S.rotrBL=S.rotrBH=S.rotrSL=S.rotrSH=S.shrSL=S.shrSH=S.toBig=S.split=S.fromBig=void 0;const Tt=BigInt(2**32-1),pr=BigInt(32);function Dr(i,e=!1){return e?{h:Number(i&Tt),l:Number(i>>pr&Tt)}:{h:Number(i>>pr&Tt)|0,l:Number(i&Tt)|0}}S.fromBig=Dr;function Gi(i,e=!1){let t=new Uint32Array(i.length),r=new Uint32Array(i.length);for(let n=0;n<i.length;n++){const{h:s,l:o}=Dr(i[n],e);[t[n],r[n]]=[s,o]}return[t,r]}S.split=Gi;const zi=(i,e)=>BigInt(i>>>0)<<pr|BigInt(e>>>0);S.toBig=zi;const Xi=(i,e,t)=>i>>>t;S.shrSH=Xi;const Zi=(i,e,t)=>i<<32-t|e>>>t;S.shrSL=Zi;const Yi=(i,e,t)=>i>>>t|e<<32-t;S.rotrSH=Yi;const en=(i,e,t)=>i<<32-t|e>>>t;S.rotrSL=en;const tn=(i,e,t)=>i<<64-t|e>>>t-32;S.rotrBH=tn;const rn=(i,e,t)=>i>>>t-32|e<<64-t;S.rotrBL=rn;const nn=(i,e)=>e;S.rotr32H=nn;const sn=(i,e)=>i;S.rotr32L=sn;const on=(i,e,t)=>i<<t|e>>>32-t;S.rotlSH=on;const an=(i,e,t)=>e<<t|i>>>32-t;S.rotlSL=an;const ln=(i,e,t)=>e<<t-32|i>>>64-t;S.rotlBH=ln;const un=(i,e,t)=>i<<t-32|e>>>64-t;S.rotlBL=un;function fn(i,e,t,r){const n=(e>>>0)+(r>>>0);return{h:i+t+(n/2**32|0)|0,l:n|0}}S.add=fn;const cn=(i,e,t)=>(i>>>0)+(e>>>0)+(t>>>0);S.add3L=cn;const dn=(i,e,t,r)=>e+t+r+(i/2**32|0)|0;S.add3H=dn;const hn=(i,e,t,r)=>(i>>>0)+(e>>>0)+(t>>>0)+(r>>>0);S.add4L=hn;const pn=(i,e,t,r,n)=>e+t+r+n+(i/2**32|0)|0;S.add4H=pn;const yn=(i,e,t,r,n)=>(i>>>0)+(e>>>0)+(t>>>0)+(r>>>0)+(n>>>0);S.add5L=yn;const mn=(i,e,t,r,n,s)=>e+t+r+n+s+(i/2**32|0)|0;S.add5H=mn;const ko={fromBig:Dr,split:Gi,toBig:zi,shrSH:Xi,shrSL:Zi,rotrSH:Yi,rotrSL:en,rotrBH:tn,rotrBL:rn,rotr32H:nn,rotr32L:sn,rotlSH:on,rotlSL:an,rotlBH:ln,rotlBL:un,add:fn,add3L:cn,add3H:dn,add4L:hn,add4H:pn,add5H:mn,add5L:yn};S.default=ko;var wn={},Vt={};Object.defineProperty(Vt,"__esModule",{value:!0});Vt.crypto=void 0;Vt.crypto=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;(function(i){/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */Object.defineProperty(i,"__esModule",{value:!0}),i.randomBytes=i.wrapXOFConstructorWithOpts=i.wrapConstructorWithOpts=i.wrapConstructor=i.checkOpts=i.Hash=i.concatBytes=i.toBytes=i.utf8ToBytes=i.asyncLoop=i.nextTick=i.hexToBytes=i.bytesToHex=i.byteSwap32=i.byteSwapIfBE=i.byteSwap=i.isLE=i.rotl=i.rotr=i.createView=i.u32=i.u8=i.isBytes=void 0;const e=Vt,t=Z;function r(g){return g instanceof Uint8Array||g!=null&&typeof g=="object"&&g.constructor.name==="Uint8Array"}i.isBytes=r;const n=g=>new Uint8Array(g.buffer,g.byteOffset,g.byteLength);i.u8=n;const s=g=>new Uint32Array(g.buffer,g.byteOffset,Math.floor(g.byteLength/4));i.u32=s;const o=g=>new DataView(g.buffer,g.byteOffset,g.byteLength);i.createView=o;const a=(g,T)=>g<<32-T|g>>>T;i.rotr=a;const l=(g,T)=>g<<T|g>>>32-T>>>0;i.rotl=l,i.isLE=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;const f=g=>g<<24&4278190080|g<<8&16711680|g>>>8&65280|g>>>24&255;i.byteSwap=f,i.byteSwapIfBE=i.isLE?g=>g:g=>(0,i.byteSwap)(g);function u(g){for(let T=0;T<g.length;T++)g[T]=(0,i.byteSwap)(g[T])}i.byteSwap32=u;const d=Array.from({length:256},(g,T)=>T.toString(16).padStart(2,"0"));function p(g){(0,t.bytes)(g);let T="";for(let q=0;q<g.length;q++)T+=d[g[q]];return T}i.bytesToHex=p;const y={_0:48,_9:57,_A:65,_F:70,_a:97,_f:102};function w(g){if(g>=y._0&&g<=y._9)return g-y._0;if(g>=y._A&&g<=y._F)return g-(y._A-10);if(g>=y._a&&g<=y._f)return g-(y._a-10)}function k(g){if(typeof g!="string")throw new Error("hex string expected, got "+typeof g);const T=g.length,q=T/2;if(T%2)throw new Error("padded hex string expected, got unpadded hex of length "+T);const L=new Uint8Array(q);for(let H=0,se=0;H<q;H++,se+=2){const Ze=w(g.charCodeAt(se)),Ye=w(g.charCodeAt(se+1));if(Ze===void 0||Ye===void 0){const vt=g[se]+g[se+1];throw new Error('hex string expected, got non-hex character "'+vt+'" at index '+se)}L[H]=Ze*16+Ye}return L}i.hexToBytes=k;const v=async()=>{};i.nextTick=v;async function F(g,T,q){let L=Date.now();for(let H=0;H<g;H++){q(H);const se=Date.now()-L;se>=0&&se<T||(await(0,i.nextTick)(),L+=se)}}i.asyncLoop=F;function I(g){if(typeof g!="string")throw new Error(`utf8ToBytes expected string, got ${typeof g}`);return new Uint8Array(new TextEncoder().encode(g))}i.utf8ToBytes=I;function Q(g){return typeof g=="string"&&(g=I(g)),(0,t.bytes)(g),g}i.toBytes=Q;function x(...g){let T=0;for(let L=0;L<g.length;L++){const H=g[L];(0,t.bytes)(H),T+=H.length}const q=new Uint8Array(T);for(let L=0,H=0;L<g.length;L++){const se=g[L];q.set(se,H),H+=se.length}return q}i.concatBytes=x;class V{clone(){return this._cloneInto()}}i.Hash=V;const ne={}.toString;function pe(g,T){if(T!==void 0&&ne.call(T)!=="[object Object]")throw new Error("Options should be object or undefined");return Object.assign(g,T)}i.checkOpts=pe;function xe(g){const T=L=>g().update(Q(L)).digest(),q=g();return T.outputLen=q.outputLen,T.blockLen=q.blockLen,T.create=()=>g(),T}i.wrapConstructor=xe;function Ne(g){const T=(L,H)=>g(H).update(Q(L)).digest(),q=g({});return T.outputLen=q.outputLen,T.blockLen=q.blockLen,T.create=L=>g(L),T}i.wrapConstructorWithOpts=Ne;function G(g){const T=(L,H)=>g(H).update(Q(L)).digest(),q=g({});return T.outputLen=q.outputLen,T.blockLen=q.blockLen,T.create=L=>g(L),T}i.wrapXOFConstructorWithOpts=G;function le(g=32){if(e.crypto&&typeof e.crypto.getRandomValues=="function")return e.crypto.getRandomValues(new Uint8Array(g));throw new Error("crypto.getRandomValues must be defined")}i.randomBytes=le})(wn);Object.defineProperty(B,"__esModule",{value:!0});B.shake256=B.shake128=B.keccak_512=B.keccak_384=B.keccak_256=B.keccak_224=B.sha3_512=B.sha3_384=B.sha3_256=B.sha3_224=B.Keccak=B.keccakP=void 0;const Ke=Z,dt=S,Ee=wn,gn=[],bn=[],vn=[],Io=BigInt(0),tt=BigInt(1),Oo=BigInt(2),Eo=BigInt(7),Co=BigInt(256),So=BigInt(113);for(let i=0,e=tt,t=1,r=0;i<24;i++){[t,r]=[r,(2*t+3*r)%5],gn.push(2*(5*r+t)),bn.push((i+1)*(i+2)/2%64);let n=Io;for(let s=0;s<7;s++)e=(e<<tt^(e>>Eo)*So)%Co,e&Oo&&(n^=tt<<(tt<<BigInt(s))-tt);vn.push(n)}const[To,Ao]=(0,dt.split)(vn,!0),li=(i,e,t)=>t>32?(0,dt.rotlBH)(i,e,t):(0,dt.rotlSH)(i,e,t),ui=(i,e,t)=>t>32?(0,dt.rotlBL)(i,e,t):(0,dt.rotlSL)(i,e,t);function _n(i,e=24){const t=new Uint32Array(10);for(let r=24-e;r<24;r++){for(let o=0;o<10;o++)t[o]=i[o]^i[o+10]^i[o+20]^i[o+30]^i[o+40];for(let o=0;o<10;o+=2){const a=(o+8)%10,l=(o+2)%10,f=t[l],u=t[l+1],d=li(f,u,1)^t[a],p=ui(f,u,1)^t[a+1];for(let y=0;y<50;y+=10)i[o+y]^=d,i[o+y+1]^=p}let n=i[2],s=i[3];for(let o=0;o<24;o++){const a=bn[o],l=li(n,s,a),f=ui(n,s,a),u=gn[o];n=i[u],s=i[u+1],i[u]=l,i[u+1]=f}for(let o=0;o<50;o+=10){for(let a=0;a<10;a++)t[a]=i[o+a];for(let a=0;a<10;a++)i[o+a]^=~t[(a+2)%10]&t[(a+4)%10]}i[0]^=To[r],i[1]^=Ao[r]}t.fill(0)}B.keccakP=_n;class bt extends Ee.Hash{constructor(e,t,r,n=!1,s=24){if(super(),this.blockLen=e,this.suffix=t,this.outputLen=r,this.enableXOF=n,this.rounds=s,this.pos=0,this.posOut=0,this.finished=!1,this.destroyed=!1,(0,Ke.number)(r),0>=this.blockLen||this.blockLen>=200)throw new Error("Sha3 supports only keccak-f1600 function");this.state=new Uint8Array(200),this.state32=(0,Ee.u32)(this.state)}keccak(){Ee.isLE||(0,Ee.byteSwap32)(this.state32),_n(this.state32,this.rounds),Ee.isLE||(0,Ee.byteSwap32)(this.state32),this.posOut=0,this.pos=0}update(e){(0,Ke.exists)(this);const{blockLen:t,state:r}=this;e=(0,Ee.toBytes)(e);const n=e.length;for(let s=0;s<n;){const o=Math.min(t-this.pos,n-s);for(let a=0;a<o;a++)r[this.pos++]^=e[s++];this.pos===t&&this.keccak()}return this}finish(){if(this.finished)return;this.finished=!0;const{state:e,suffix:t,pos:r,blockLen:n}=this;e[r]^=t,t&128&&r===n-1&&this.keccak(),e[n-1]^=128,this.keccak()}writeInto(e){(0,Ke.exists)(this,!1),(0,Ke.bytes)(e),this.finish();const t=this.state,{blockLen:r}=this;for(let n=0,s=e.length;n<s;){this.posOut>=r&&this.keccak();const o=Math.min(r-this.posOut,s-n);e.set(t.subarray(this.posOut,this.posOut+o),n),this.posOut+=o,n+=o}return e}xofInto(e){if(!this.enableXOF)throw new Error("XOF is not possible for this instance");return this.writeInto(e)}xof(e){return(0,Ke.number)(e),this.xofInto(new Uint8Array(e))}digestInto(e){if((0,Ke.output)(e,this),this.finished)throw new Error("digest() was already called");return this.writeInto(e),this.destroy(),e}digest(){return this.digestInto(new Uint8Array(this.outputLen))}destroy(){this.destroyed=!0,this.state.fill(0)}_cloneInto(e){const{blockLen:t,suffix:r,outputLen:n,rounds:s,enableXOF:o}=this;return e||(e=new bt(t,r,n,o,s)),e.state32.set(this.state32),e.pos=this.pos,e.posOut=this.posOut,e.finished=this.finished,e.rounds=s,e.suffix=r,e.outputLen=n,e.enableXOF=o,e.destroyed=this.destroyed,e}}B.Keccak=bt;const Me=(i,e,t)=>(0,Ee.wrapConstructor)(()=>new bt(e,i,t));B.sha3_224=Me(6,144,224/8);B.sha3_256=Me(6,136,256/8);B.sha3_384=Me(6,104,384/8);B.sha3_512=Me(6,72,512/8);B.keccak_224=Me(1,144,224/8);B.keccak_256=Me(1,136,256/8);B.keccak_384=Me(1,104,384/8);B.keccak_512=Me(1,72,512/8);const kn=(i,e,t)=>(0,Ee.wrapXOFConstructorWithOpts)((r={})=>new bt(e,i,r.dkLen===void 0?t:r.dkLen,!0));B.shake128=kn(31,168,128/8);B.shake256=kn(31,136,256/8);const{sha3_512:Fo}=B,In=24,ut=32,yr=(i=4,e=Math.random)=>{let t="";for(;t.length<i;)t=t+Math.floor(e()*36).toString(36);return t};function On(i){let e=8n,t=0n;for(const r of i.values()){const n=BigInt(r);t=(t<<e)+n}return t}const En=(i="")=>On(Fo(i)).toString(36).slice(1),fi=Array.from({length:26},(i,e)=>String.fromCharCode(e+97)),Po=i=>fi[Math.floor(i()*fi.length)],Cn=({globalObj:i=typeof qt<"u"?qt:typeof window<"u"?window:{},random:e=Math.random}={})=>{const t=Object.keys(i).toString(),r=t.length?t+yr(ut,e):yr(ut,e);return En(r).substring(0,ut)},Sn=i=>()=>i++,Ro=476782367,Tn=({random:i=Math.random,counter:e=Sn(Math.floor(i()*Ro)),length:t=In,fingerprint:r=Cn({random:i})}={})=>function(){const s=Po(i),o=Date.now().toString(36),a=e().toString(36),l=yr(t,i),f=`${o+l+a+r}`;return`${s+En(f).substring(1,t)}`},Do=Tn(),Mo=(i,{minLength:e=2,maxLength:t=ut}={})=>{const r=i.length,n=/^[0-9a-z]+$/;try{if(typeof i=="string"&&r>=e&&r<=t&&n.test(i))return!0}finally{}return!1};De.getConstants=()=>({defaultLength:In,bigLength:ut});De.init=Tn;De.createId=Do;De.bufToBigInt=On;De.createCounter=Sn;De.createFingerprint=Cn;De.isCuid=Mo;const{createId:No,init:Qo,getConstants:Go,isCuid:zo}=De;var ci=No;const di=Pt(i=>!isNaN(i)&&isFinite(i));class Mr{static object(...e){return fe(void 0,...e)}static json(...e){let t=e;return t.valueConverter&&!t.valueConverter.fieldTypeInDb&&(t.valueConverter.fieldTypeInDb="json"),fe(void 0,{valueConverter:{fieldTypeInDb:"json"}},...e)}static dateOnly(...e){return fe(()=>Date,{valueConverter:ae.DateOnly},...e)}static date(...e){return fe(()=>Date,...e)}static integer(...e){return fe(()=>Number,{valueConverter:ae.Integer,validate:di},...e)}static autoIncrement(...e){return fe(()=>Number,{allowApiUpdate:!1,dbReadOnly:!0,valueConverter:{...ae.Integer,fieldTypeInDb:"autoincrement"}},...e)}static number(...e){return fe(()=>Number,{validate:di},...e)}static createdAt(...e){return fe(()=>Date,{allowApiUpdate:!1,saving:(t,r,{isNew:n})=>{n&&(r.value=new Date)}},...e)}static updatedAt(...e){return fe(()=>Date,{allowApiUpdate:!1,saving:(t,r)=>{r.value=new Date}},...e)}static uuid(...e){return fe(()=>String,{allowApiUpdate:!1,defaultValue:()=>fr(),saving:(t,r)=>{r.value||(r.value=fr())}},...e)}static cuid(...e){return fe(()=>String,{allowApiUpdate:!1,defaultValue:()=>ci(),saving:(t,r)=>{r.value||(r.value=ci())}},...e)}static literal(e,...t){return Mr.string({validate:(r,n)=>Ce.in(e())(r,n),[tr]:e},...t)}static enum(e,...t){let r;return fe(()=>e(),{validate:(n,s)=>Ce.enum(e())(n,s),[tr]:()=>Rt(e())},...t,n=>{if(n[tr]=()=>Rt(e()),r===void 0){let s=e();r=Rt(s).find(a=>typeof a=="string")?ae.String:ae.Integer}n.valueConverter?n.valueConverter.fieldTypeInDb||(n.valueConverter.fieldTypeInDb=r.fieldTypeInDb):n.valueConverter=r})}static string(...e){return fe(()=>String,...e)}static boolean(...e){return fe(()=>Boolean,...e)}}function fe(i,...e){return(t,r,n)=>{const s=typeof r=="string"?r:r.name.toString();let o=f=>{let u=ji(e,f);u.required&&(u.validate=Dt(u.validate,Ce.required,!0)),u.maxLength&&(u.validate=Dt(u.validate,Ce.maxLength(u.maxLength))),u.minLength&&(u.validate=Dt(u.validate,Ce.minLength(u.minLength))),!u.valueType&&i&&(u.valueType=i()),u.key||(u.key=s),u.dbName||(u.dbName=u.key);let d=u.valueType;return d||(d=typeof Reflect.getMetadata=="function"?Reflect.getMetadata("design:type",t,s):[],u.valueType=d),u.target||(u.target=t),u};An(t);let a=O.columnsOfType.get(t.constructor);a||(a=[],O.columnsOfType.set(t.constructor,a));let l=a.find(f=>f.key==s);if(!l)a.push({key:s,settings:o});else{let f=l.settings;l.settings=u=>{let d=f(u),p=o(u);return Object.assign(d,p)}}}}function An(i){if(!i)throw new Error("Set the 'experimentalDecorators:true' option in your 'tsconfig' or 'jsconfig' (target undefined)")}function Lo(i,e,t,r){var n=arguments.length,s=n<3?e:r===null?r=Object.getOwnPropertyDescriptor(e,t):r,o;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(i,e,t,r);else for(var a=i.length-1;a>=0;a--)(o=i[a])&&(s=(n<3?o(s):n>3?o(e,t,s):o(e,t))||s);return n>3&&s&&Object.defineProperty(e,t,s),s}function Bo(i,e){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(i,e)}class qo extends Ji{constructor(){super(...arguments);c(this,"id")}}Lo([Mr.uuid(),Bo("design:type",String)],qo.prototype,"id",void 0);/*! *****************************************************************************
Copyright (C) Microsoft. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */var hi;(function(i){(function(e){var t=typeof qt=="object"?qt:typeof self=="object"?self:typeof this=="object"?this:Function("return this;")(),r=n(i);typeof t.Reflect>"u"?t.Reflect=i:r=n(t.Reflect,r),e(r);function n(s,o){return function(a,l){typeof s[a]!="function"&&Object.defineProperty(s,a,{configurable:!0,writable:!0,value:l}),o&&o(a,l)}}})(function(e){var t=Object.prototype.hasOwnProperty,r=typeof Symbol=="function",n=r&&typeof Symbol.toPrimitive<"u"?Symbol.toPrimitive:"@@toPrimitive",s=r&&typeof Symbol.iterator<"u"?Symbol.iterator:"@@iterator",o=typeof Object.create=="function",a={__proto__:[]}instanceof Array,l=!o&&!a,f={create:o?function(){return Wt(Object.create(null))}:a?function(){return Wt({__proto__:null})}:function(){return Wt({})},has:l?function(h,m){return t.call(h,m)}:function(h,m){return m in h},get:l?function(h,m){return t.call(h,m)?h[m]:void 0}:function(h,m){return h[m]}},u=Object.getPrototypeOf(Function),d=typeof process=="object"&&process.env&&process.env.REFLECT_METADATA_USE_MAP_POLYFILL==="true",p=!d&&typeof Map=="function"&&typeof Map.prototype.entries=="function"?Map:Xn(),y=!d&&typeof Set=="function"&&typeof Set.prototype.entries=="function"?Set:Zn(),w=!d&&typeof WeakMap=="function"?WeakMap:Yn(),k=new w;function v(h,m,b,_){if(z(b)){if(!Nr(h))throw new TypeError;if(!Lr(m))throw new TypeError;return G(h,m)}else{if(!Nr(h))throw new TypeError;if(!X(m))throw new TypeError;if(!X(_)&&!z(_)&&!Ve(_))throw new TypeError;return Ve(_)&&(_=void 0),b=Oe(b),le(h,m,b,_)}}e("decorate",v);function F(h,m){function b(_,E){if(!X(_))throw new TypeError;if(!z(E)&&!$n(E))throw new TypeError;se(h,m,_,E)}return b}e("metadata",F);function I(h,m,b,_){if(!X(b))throw new TypeError;return z(_)||(_=Oe(_)),se(h,m,b,_)}e("defineMetadata",I);function Q(h,m,b){if(!X(m))throw new TypeError;return z(b)||(b=Oe(b)),T(h,m,b)}e("hasMetadata",Q);function x(h,m,b){if(!X(m))throw new TypeError;return z(b)||(b=Oe(b)),q(h,m,b)}e("hasOwnMetadata",x);function V(h,m,b){if(!X(m))throw new TypeError;return z(b)||(b=Oe(b)),L(h,m,b)}e("getMetadata",V);function ne(h,m,b){if(!X(m))throw new TypeError;return z(b)||(b=Oe(b)),H(h,m,b)}e("getOwnMetadata",ne);function pe(h,m){if(!X(h))throw new TypeError;return z(m)||(m=Oe(m)),Ze(h,m)}e("getMetadataKeys",pe);function xe(h,m){if(!X(h))throw new TypeError;return z(m)||(m=Oe(m)),Ye(h,m)}e("getOwnMetadataKeys",xe);function Ne(h,m,b){if(!X(m))throw new TypeError;z(b)||(b=Oe(b));var _=g(m,b,!1);if(z(_)||!_.delete(h))return!1;if(_.size>0)return!0;var E=k.get(m);return E.delete(b),E.size>0||k.delete(m),!0}e("deleteMetadata",Ne);function G(h,m){for(var b=h.length-1;b>=0;--b){var _=h[b],E=_(m);if(!z(E)&&!Ve(E)){if(!Lr(E))throw new TypeError;m=E}}return m}function le(h,m,b,_){for(var E=h.length-1;E>=0;--E){var Y=h[E],P=Y(m,b,_);if(!z(P)&&!Ve(P)){if(!X(P))throw new TypeError;_=P}}return _}function g(h,m,b){var _=k.get(h);if(z(_)){if(!b)return;_=new p,k.set(h,_)}var E=_.get(m);if(z(E)){if(!b)return;E=new p,_.set(m,E)}return E}function T(h,m,b){var _=q(h,m,b);if(_)return!0;var E=Ht(m);return Ve(E)?!1:T(h,E,b)}function q(h,m,b){var _=g(m,b,!1);return z(_)?!1:Hn(_.has(h))}function L(h,m,b){var _=q(h,m,b);if(_)return H(h,m,b);var E=Ht(m);if(!Ve(E))return L(h,E,b)}function H(h,m,b){var _=g(m,b,!1);if(!z(_))return _.get(h)}function se(h,m,b,_){var E=g(b,_,!0);E.set(h,m)}function Ze(h,m){var b=Ye(h,m),_=Ht(h);if(_===null)return b;var E=Ze(_,m);if(E.length<=0)return b;if(b.length<=0)return E;for(var Y=new y,P=[],D=0,C=b;D<C.length;D++){var M=C[D],N=Y.has(M);N||(Y.add(M),P.push(M))}for(var Se=0,qr=E;Se<qr.length;Se++){var M=qr[Se],N=Y.has(M);N||(Y.add(M),P.push(M))}return P}function Ye(h,m){var b=[],_=g(h,m,!1);if(z(_))return b;for(var E=_.keys(),Y=Kn(E),P=0;;){var D=Gn(Y);if(!D)return b.length=P,b;var C=Qn(D);try{b[P]=C}catch(M){try{zn(Y)}finally{throw M}}P++}}function vt(h){if(h===null)return 1;switch(typeof h){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return h===null?1:6;default:return 6}}function z(h){return h===void 0}function Ve(h){return h===null}function Un(h){return typeof h=="symbol"}function X(h){return typeof h=="object"?h!==null:typeof h=="function"}function xn(h,m){switch(vt(h)){case 0:return h;case 1:return h;case 2:return h;case 3:return h;case 4:return h;case 5:return h}var b=m===3?"string":m===5?"number":"default",_=Br(h,n);if(_!==void 0){var E=_.call(h,b);if(X(E))throw new TypeError;return E}return Vn(h,b==="default"?"number":b)}function Vn(h,m){if(m==="string"){var b=h.toString;if(He(b)){var _=b.call(h);if(!X(_))return _}var E=h.valueOf;if(He(E)){var _=E.call(h);if(!X(_))return _}}else{var E=h.valueOf;if(He(E)){var _=E.call(h);if(!X(_))return _}var Y=h.toString;if(He(Y)){var _=Y.call(h);if(!X(_))return _}}throw new TypeError}function Hn(h){return!!h}function Wn(h){return""+h}function Oe(h){var m=xn(h,3);return Un(m)?m:Wn(m)}function Nr(h){return Array.isArray?Array.isArray(h):h instanceof Object?h instanceof Array:Object.prototype.toString.call(h)==="[object Array]"}function He(h){return typeof h=="function"}function Lr(h){return typeof h=="function"}function $n(h){switch(vt(h)){case 3:return!0;case 4:return!0;default:return!1}}function Br(h,m){var b=h[m];if(b!=null){if(!He(b))throw new TypeError;return b}}function Kn(h){var m=Br(h,s);if(!He(m))throw new TypeError;var b=m.call(h);if(!X(b))throw new TypeError;return b}function Qn(h){return h.value}function Gn(h){var m=h.next();return m.done?!1:m}function zn(h){var m=h.return;m&&m.call(h)}function Ht(h){var m=Object.getPrototypeOf(h);if(typeof h!="function"||h===u||m!==u)return m;var b=h.prototype,_=b&&Object.getPrototypeOf(b);if(_==null||_===Object.prototype)return m;var E=_.constructor;return typeof E!="function"||E===h?m:E}function Xn(){var h={},m=[],b=function(){function P(D,C,M){this._index=0,this._keys=D,this._values=C,this._selector=M}return P.prototype["@@iterator"]=function(){return this},P.prototype[s]=function(){return this},P.prototype.next=function(){var D=this._index;if(D>=0&&D<this._keys.length){var C=this._selector(this._keys[D],this._values[D]);return D+1>=this._keys.length?(this._index=-1,this._keys=m,this._values=m):this._index++,{value:C,done:!1}}return{value:void 0,done:!0}},P.prototype.throw=function(D){throw this._index>=0&&(this._index=-1,this._keys=m,this._values=m),D},P.prototype.return=function(D){return this._index>=0&&(this._index=-1,this._keys=m,this._values=m),{value:D,done:!0}},P}();return function(){function P(){this._keys=[],this._values=[],this._cacheKey=h,this._cacheIndex=-2}return Object.defineProperty(P.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),P.prototype.has=function(D){return this._find(D,!1)>=0},P.prototype.get=function(D){var C=this._find(D,!1);return C>=0?this._values[C]:void 0},P.prototype.set=function(D,C){var M=this._find(D,!0);return this._values[M]=C,this},P.prototype.delete=function(D){var C=this._find(D,!1);if(C>=0){for(var M=this._keys.length,N=C+1;N<M;N++)this._keys[N-1]=this._keys[N],this._values[N-1]=this._values[N];return this._keys.length--,this._values.length--,D===this._cacheKey&&(this._cacheKey=h,this._cacheIndex=-2),!0}return!1},P.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=h,this._cacheIndex=-2},P.prototype.keys=function(){return new b(this._keys,this._values,_)},P.prototype.values=function(){return new b(this._keys,this._values,E)},P.prototype.entries=function(){return new b(this._keys,this._values,Y)},P.prototype["@@iterator"]=function(){return this.entries()},P.prototype[s]=function(){return this.entries()},P.prototype._find=function(D,C){return this._cacheKey!==D&&(this._cacheIndex=this._keys.indexOf(this._cacheKey=D)),this._cacheIndex<0&&C&&(this._cacheIndex=this._keys.length,this._keys.push(D),this._values.push(void 0)),this._cacheIndex},P}();function _(P,D){return P}function E(P,D){return D}function Y(P,D){return[P,D]}}function Zn(){return function(){function h(){this._map=new p}return Object.defineProperty(h.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),h.prototype.has=function(m){return this._map.has(m)},h.prototype.add=function(m){return this._map.set(m,m),this},h.prototype.delete=function(m){return this._map.delete(m)},h.prototype.clear=function(){this._map.clear()},h.prototype.keys=function(){return this._map.keys()},h.prototype.values=function(){return this._map.values()},h.prototype.entries=function(){return this._map.entries()},h.prototype["@@iterator"]=function(){return this.keys()},h.prototype[s]=function(){return this.keys()},h}()}function Yn(){var h=16,m=f.create(),b=_();return function(){function C(){this._key=_()}return C.prototype.has=function(M){var N=E(M,!1);return N!==void 0?f.has(N,this._key):!1},C.prototype.get=function(M){var N=E(M,!1);return N!==void 0?f.get(N,this._key):void 0},C.prototype.set=function(M,N){var Se=E(M,!0);return Se[this._key]=N,this},C.prototype.delete=function(M){var N=E(M,!1);return N!==void 0?delete N[this._key]:!1},C.prototype.clear=function(){this._key=_()},C}();function _(){var C;do C="@@WeakMap@@"+D();while(f.has(m,C));return m[C]=!0,C}function E(C,M){if(!t.call(C,b)){if(!M)return;Object.defineProperty(C,b,{value:f.create()})}return C[b]}function Y(C,M){for(var N=0;N<M;++N)C[N]=Math.random()*255|0;return C}function P(C){return typeof Uint8Array=="function"?typeof crypto<"u"?crypto.getRandomValues(new Uint8Array(C)):typeof msCrypto<"u"?msCrypto.getRandomValues(new Uint8Array(C)):Y(new Uint8Array(C),C):Y(new Array(C),C)}function D(){var C=P(h);C[6]=C[6]&79|64,C[8]=C[8]&191|128;for(var M="",N=0;N<h;++N){var Se=C[N];(N===4||N===6||N===8)&&(M+="-"),Se<16&&(M+="0"),M+=Se.toString(16).toLowerCase()}return M}}function Wt(h){return h.__=void 0,delete h.__,h}})})(hi||(hi={}));const Jt=class Jt{constructor(e,t,r){c(this,"actionUrl");c(this,"queue");c(this,"allowed");c(this,"doWork");this.actionUrl=e,this.queue=t,this.allowed=r}async run(e,t,r){t===void 0&&(t=ye.apiClient.url),r||(r=gt(ye.apiClient.httpClient));let n=await r.post(t+"/"+this.actionUrl,e),s=n;if(s&&s.queuedJobId){let o=O.actionInfo.startBusyWithProgress();try{let a;if(await O.actionInfo.runActionWithoutBlockingUI(async()=>{for(;!a||!a.done;)a&&await new Promise(l=>setTimeout(()=>{l(void 0)},200)),a=await r.post(t+"/"+Jt.apiUrlForJobStatus,{queuedJobId:n.queuedJobId}),a.progress&&o.progress(a.progress)}),a.error)throw a.error;return o.progress(1),a.result}finally{o.close()}}else return n}__register(e){e(this.actionUrl,this.queue,this.allowed,async(t,r,n)=>{try{var s=await this.execute(t,r,n);n.success(s)}catch(o){o.isForbiddenError?n.forbidden():n.error(o,void 0)}})}};c(Jt,"apiUrlForJobStatus","jobStatusInQueue");let ht=Jt;class mr extends Error{constructor(t="Forbidden"){super(t);c(this,"isForbiddenError",!0)}}class jo extends ht{constructor(t,r,n,s){super(t,n.queue,n.allowed);c(this,"types");c(this,"options");c(this,"originalMethod");this.types=r,this.options=n,this.originalMethod=s}async execute(t,r,n){let s={data:{}},o=r.dataProvider;return await Mi(r,async()=>{if(!r.isAllowedForInstance(void 0,this.options.allowed))throw new mr;t.args=await Pn(this.types(),t.args,r,o,n);try{s.data=await this.originalMethod(t.args)}catch(a){throw a}}),s}}function ke(i){return(e,t,r)=>{const n=typeof t=="string"?t:t.name.toString(),s=r?r.value:e;let o=s;An(e);function a(){var u=typeof Reflect.getMetadata=="function"?Reflect.getMetadata("design:paramtypes",e,n):[];return i.paramTypes&&(u=typeof i.paramTypes=="function"?i.paramTypes():i.paramTypes),u}if(e.prototype!==void 0){let u=new jo((i!=null&&i.apiPrefix?i.apiPrefix+"/":"")+n,()=>a(),i,d=>s.apply(void 0,d));return u.doWork=async(d,p,y,w)=>(d=mi(a(),d),i.blockUser===!1?await O.actionInfo.runActionWithoutBlockingUI(async()=>(await u.run({args:d},y,w)).data):(await u.run({args:d},y,w)).data),o=async function(...d){return dr()?await s.apply(this,d):await u.doWork(d,void 0)},pi(e,o),o[cr]=u,r?(r.value=o,r):o}let l=O.classHelpers.get(e.constructor);l||(l=new Ys,O.classHelpers.set(e.constructor,l));let f={__register(u){let d=new ve;for(const p of l.classes.keys()){let y=l.classes.get(p);y.key||(y.key=d.repo(p).metadata.key),u(y.key+"/"+(i!=null&&i.apiPrefix?i.apiPrefix+"/":"")+n,i?i.queue:!1,i.allowed,async(w,k,v)=>{w.args=w.args.map(I=>Fn(I)?void 0:I);let F=i.allowed;try{let I=k,Q;await Mi(I,async()=>{if(w.args=await Pn(a(),w.args,I,I.dataProvider,v),O.allEntities.includes(p)){let x=I.repo(p),V;if(w.rowInfo.isNewRow)V=x.create(),await x.getEntityRef(V)._updateEntityBasedOnApi(w.rowInfo.data);else{let pe=await x.find({where:{...x.metadata.idMetadata.getIdFilter(w.rowInfo.id),$and:[x.metadata.options.apiPrefilter]}});if(pe.length!=1)throw new Error("not found or too many matches");V=pe[0],await x.getEntityRef(V)._updateEntityBasedOnApi(w.rowInfo.data)}if(!I.isAllowedForInstance(V,F))throw new mr;let ne=j(V);await ne.__validateEntity();try{Q={result:await s.apply(V,w.args),rowInfo:{data:await ne.toApiJson(),isNewRow:ne.isNew(),wasChanged:ne.wasChanged(),id:ne.getOriginalId()}}}catch(pe){throw ne.catchSaveErrors(pe)}}else{let x=new p(I,I.dataProvider),V=si(x,I);if(await V._updateEntityBasedOnApi(w.fields),!I.isAllowedForInstance(x,F))throw new mr;await V.__validateEntity();try{Q={result:await s.apply(x,w.args),fields:await V.toApiJson()}}catch(ne){throw V.catchSaveErrors(ne)}}}),v.success(Q)}catch(I){I.isForbiddenError?v.forbidden():v.error(I,void 0)}})}},doWork:async function(u,d,p,y){if(u=mi(a(),u),O.allEntities.includes(e.constructor)){let w=j(d);await w.__validateEntity();let k=l.classes.get(d.constructor);k.key||(k.key=w.repository.metadata.key+"_methods");try{let v=await new class extends ht{constructor(){super(...arguments);c(this,"execute")}}(k.key+"/"+(i!=null&&i.apiPrefix?i.apiPrefix+"/":"")+n,i?i.queue:!1,i.allowed).run({args:u,rowInfo:{data:await w.toApiJson(),isNewRow:w.isNew(),wasChanged:w.wasChanged(),id:w.getOriginalId()}},p,y);return await w._updateEntityBasedOnApi(v.rowInfo.data,!0),v.result}catch(v){throw w.catchSaveErrors(v)}}else{let w=si(d,void 0);try{await w.__validateEntity();let k=await new class extends ht{constructor(){super(...arguments);c(this,"execute")}}(l.classes.get(d.constructor).key+"/"+(i!=null&&i.apiPrefix?i.apiPrefix+"/":"")+n,i?i.queue:!1,i.allowed).run({args:u,fields:await w.toApiJson()},p,y);return await w._updateEntityBasedOnApi(k.fields),k.result}catch(k){throw w.catchSaveErrors(k)}}}};return o=async function(...u){if(dr())return await s.apply(this,u);{let d=this;return f.doWork(u,d)}},pi(e.constructor,o),o[cr]=f,r?(r.value=o,r):o}}const Jo={_isUndefined:!0};function pi(i,e){(i[wi]||(i[wi]=[])).push(e),O.actionInfo.allActions.push(e)}function Fn(i){return i&&i._isUndefined}class yi{constructor(e){c(this,"res");this.res=e}progress(e){this.res.progress(e)}}function mi(i,e){if(i)for(let t=0;t<i.length;t++){const r=i[t];for(const n of[ve,Xe])(e[t]instanceof n||r==n)&&(e[t]=void 0);if(e[t]!=null){let n={valueType:r};if(n=Fr(n,new ve),he(r,!1)!=null){let o=j(e[t]);e[t]=o.getId()}n.valueConverter&&(e[t]=n.valueConverter.toJson(e[t]))}}return e.map(t=>t!==void 0?t:Jo)}async function Pn(i,e,t,r,n){for(let s=0;s<e.length;s++){const o=e[s];Fn(o)&&(e[s]=void 0)}if(i)for(let s=0;s<i.length;s++)if(e.length<s&&e.push(void 0),i[s]==ve||i[s]==ve)e[s]=t;else if(i[s]==Xe&&r)e[s]=r;else if(i[s]==yi)e[s]=new yi(n);else{let o={valueType:i[s]};o=Fr(o,t),o.valueConverter&&(e[s]=o.valueConverter.fromJson(e[s])),he(i[s],!1)!=null&&(e[s]===null||e[s]===void 0||(e[s]=await t.repo(i[s]).findId(e[s])))}return e}const wi=Symbol.for("classBackendMethodsArray");var Uo=Object.defineProperty,xo=Object.getOwnPropertyDescriptor,Ie=(i,e,t,r)=>{for(var n=r>1?void 0:r?xo(e,t):e,s=i.length-1,o;s>=0;s--)(o=i[s])&&(n=(r?o(e,t,n):o(n))||n);return r&&n&&Uo(e,t,n),n};class we{static async signOut(){}static async signInDemo(){}static async invite(){}static async signUpPassword(){}static async signInPassword(){}static async forgotPassword(){}static async resetPassword(){}static async signInOTP(){}static async verifyOtp(){}static async signInOAuthGetUrl(){}}Ie([ke({})],we,"signOut",1);Ie([ke({})],we,"signInDemo",1);Ie([ke({})],we,"invite",1);Ie([ke({})],we,"signUpPassword",1);Ie([ke({})],we,"signInPassword",1);Ie([ke({})],we,"forgotPassword",1);Ie([ke({})],we,"resetPassword",1);Ie([ke({})],we,"signInOTP",1);Ie([ke({})],we,"verifyOtp",1);Ie([ke({})],we,"signInOAuthGetUrl",1);O.actionInfo;function Vo(i){return i}const{Error:ge}=bi,Le="src/lib/modules/auth/components/SignUp.svelte";function wr(i){let e,t,r,n,s,o,a=i[3].providers.password.dico.email+"",l,f,u,d,p,y,w=i[3].providers.password.dico.password+"",k,v,F,I,Q,x=i[3].providers.password.dico.btn_sign_in+"",V,ne,pe;const xe={c:function(){e=W("form"),t=W("p"),r=Te(i[1]),n=Te(i[2]),s=be(),o=W("label"),l=Te(a),f=be(),u=W("input"),p=be(),y=W("label"),k=Te(w),v=be(),F=W("input"),I=be(),Q=W("button"),V=Te(x),te(t,"class","message s-FRwn6sVlvC6z"),Vr(t,"error",i[1]),$(t,Le,36,4,736),te(u,"type","text"),te(u,"placeholder",d=i[3].providers.password.dico.email_placeholder),$(u,Le,39,6,879),$(o,Le,37,4,809),te(F,"type","password"),$(F,Le,48,6,1136),$(y,Le,46,4,1063),$(Q,Le,50,4,1201),te(e,"class","s-FRwn6sVlvC6z"),$(e,Le,35,2,691)},m:function(G,le){re(G,e,le),J(e,t),J(t,r),J(t,n),J(e,s),J(e,o),J(o,l),J(o,f),J(o,u),_t(u,i[0]),J(e,p),J(e,y),J(y,k),J(y,v),J(y,F),_t(F,i[5]),J(e,I),J(e,Q),J(Q,V),ne||(pe=[At(u,"input",i[7]),_r(xt.call(null,u)),At(F,"input",i[8]),At(e,"submit",fs(i[6]),!1,!0,!1,!1)],ne=!0)},p:function(G,le){le&2&&Qe(r,G[1]),le&4&&Qe(n,G[2]),le&2&&Vr(t,"error",G[1]),le&8&&a!==(a=G[3].providers.password.dico.email+"")&&Qe(l,a),le&8&&d!==(d=G[3].providers.password.dico.email_placeholder)&&te(u,"placeholder",d),le&1&&u.value!==G[0]&&_t(u,G[0]),le&8&&w!==(w=G[3].providers.password.dico.password+"")&&Qe(k,w),le&32&&F.value!==G[5]&&_t(F,G[5]),le&8&&x!==(x=G[3].providers.password.dico.btn_sign_in+"")&&Qe(V,x)},d:function(G){G&&ie(e),ne=!1,vr(pe)}};return K("SvelteRegisterBlock",{block:xe,id:wr.name,type:"if",source:"(26:0) {#if view == 'login'}",ctx:i}),xe}function gr(i){let e,t=i[4]=="login"&&wr(i);const r={c:function(){t&&t.c(),e=_i()},l:function(s){throw new ge("options.hydrate only works if the component was compiled with the `hydratable: true` option")},m:function(s,o){t&&t.m(s,o),re(s,e,o)},p:function(s,[o]){s[4]=="login"?t?t.p(s,o):(t=wr(s),t.c(),t.m(e.parentNode,e)):t&&(t.d(1),t=null)},i:me,o:me,d:function(s){s&&ie(e),t&&t.d(s)}};return K("SvelteRegisterBlock",{block:r,id:gr.name,type:"component",source:"",ctx:i}),r}function Ho(i,e,t){let{$$slots:r={},$$scope:n}=e;mt("SignUp",r,[]);let{remultKitDataAuth:s}=e,{view:o="login"}=e,{email:a=""}=e,{msgError:l=""}=e,{msgSuccess:f=""}=e,u;async function d(){t(1,l=""),t(2,f="");try{await we.signInPassword(a,u)}catch(v){v&&t(1,l=v.message??"")}}const p=()=>{throw new Error("Not impl yet")};i.$$.on_mount.push(function(){s===void 0&&!("remultKitDataAuth"in e||i.$$.bound[i.$$.props.remultKitDataAuth])&&console.warn("<SignUp> was created without expected prop 'remultKitDataAuth'")});const y=["remultKitDataAuth","view","email","msgError","msgSuccess"];Object.keys(e).forEach(v=>{!~y.indexOf(v)&&v.slice(0,2)!=="$$"&&v!=="slot"&&console.warn(`<SignUp> was created with unknown prop '${v}'`)});function w(){a=this.value,t(0,a)}function k(){u=this.value,t(5,u)}return i.$$set=v=>{"remultKitDataAuth"in v&&t(3,s=v.remultKitDataAuth),"view"in v&&t(4,o=v.view),"email"in v&&t(0,a=v.email),"msgError"in v&&t(1,l=v.msgError),"msgSuccess"in v&&t(2,f=v.msgSuccess)},i.$capture_state=()=>({AuthController:we,isError:Vo,autofocus:xt,remultKitDataAuth:s,view:o,email:a,msgError:l,msgSuccess:f,password:u,signIn:d,handlePin:p}),i.$inject_state=v=>{"remultKitDataAuth"in v&&t(3,s=v.remultKitDataAuth),"view"in v&&t(4,o=v.view),"email"in v&&t(0,a=v.email),"msgError"in v&&t(1,l=v.msgError),"msgSuccess"in v&&t(2,f=v.msgSuccess),"password"in v&&t(5,u=v.password)},e&&"$$inject"in e&&i.$inject_state(e.$$inject),[a,l,f,s,o,u,d,w,k]}class Rn extends pt{constructor(e){super(e),yt(this,e,Ho,gr,Ut,{remultKitDataAuth:3,view:4,email:0,msgError:1,msgSuccess:2}),K("SvelteRegisterComponent",{component:this,tagName:"SignUp",options:e,id:gr.name})}get remultKitDataAuth(){throw new ge("<SignUp>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set remultKitDataAuth(e){throw new ge("<SignUp>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get view(){throw new ge("<SignUp>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set view(e){throw new ge("<SignUp>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get email(){throw new ge("<SignUp>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set email(e){throw new ge("<SignUp>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get msgError(){throw new ge("<SignUp>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set msgError(e){throw new ge("<SignUp>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get msgSuccess(){throw new ge("<SignUp>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set msgSuccess(e){throw new ge("<SignUp>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}}const Ae="src/lib/modules/auth/Page.svelte";function Dn(i){var n;let e,t;e=new Or({props:{href:(n=i[0].providers)==null?void 0:n.password.paths.forgot_password,$$slots:{default:[Mn]},$$scope:{ctx:i}},$$inline:!0});const r={c:function(){Fe(e.$$.fragment)},m:function(o,a){Pe(e,o,a),t=!0},p:function(o,a){const l={};a&4&&(l.$$scope={dirty:a,ctx:o}),e.$set(l)},i:function(o){t||(ue(e.$$.fragment,o),t=!0)},o:function(o){de(e.$$.fragment,o),t=!1},d:function(o){Re(e,o)}};return K("SvelteRegisterBlock",{block:r,id:Dn.name,type:"if",source:"(15:10) {#if remultKitDataAuth.providers?.password.paths.forgot_password}",ctx:i}),r}function Mn(i){let e=i[0].providers.password.dico.forgot_password+"",t;const r={c:function(){t=Te(e)},m:function(s,o){re(s,t,o)},p:me,d:function(s){s&&ie(t)}};return K("SvelteRegisterBlock",{block:r,id:Mn.name,type:"slot",source:"(16:12) <Link href={remultKitDataAuth.providers?.password.paths.forgot_password}>",ctx:i}),r}function Nn(i){var a;let e,t,r,n;e=new Rn({props:{remultKitDataAuth:i[0]},$$inline:!0});let s=((a=i[0].providers)==null?void 0:a.password.paths.forgot_password)&&Dn(i);const o={c:function(){Fe(e.$$.fragment),t=be(),r=W("div"),s&&s.c(),te(r,"class","form-footer s-NO-a_LAEXXH5"),$(r,Ae,17,8,434)},m:function(f,u){Pe(e,f,u),re(f,t,u),re(f,r,u),s&&s.m(r,null),n=!0},p:function(f,u){var d;(d=f[0].providers)!=null&&d.password.paths.forgot_password&&s.p(f,u)},i:function(f){n||(ue(e.$$.fragment,f),ue(s),n=!0)},o:function(f){de(e.$$.fragment,f),de(s),n=!1},d:function(f){f&&(ie(t),ie(r)),Re(e,f),s&&s.d()}};return K("SvelteRegisterBlock",{block:o,id:Nn.name,type:"slot",source:"(11:6) <Route path={remultKitDataAuth.providers?.password.paths.sign_in}>",ctx:i}),o}function Ln(i){var n;let e,t;e=new Or({props:{href:(n=i[0].providers)==null?void 0:n.password.paths.sign_in,$$slots:{default:[Bn]},$$scope:{ctx:i}},$$inline:!0});const r={c:function(){Fe(e.$$.fragment)},m:function(o,a){Pe(e,o,a),t=!0},p:function(o,a){const l={};a&4&&(l.$$scope={dirty:a,ctx:o}),e.$set(l)},i:function(o){t||(ue(e.$$.fragment,o),t=!0)},o:function(o){de(e.$$.fragment,o),t=!1},d:function(o){Re(e,o)}};return K("SvelteRegisterBlock",{block:r,id:Ln.name,type:"if",source:"(27:10) {#if remultKitDataAuth.providers?.password.paths.sign_in}",ctx:i}),r}function Bn(i){let e=i[0].providers.password.dico.back_to_sign_in+"",t;const r={c:function(){t=Te(e)},m:function(s,o){re(s,t,o)},p:me,d:function(s){s&&ie(t)}};return K("SvelteRegisterBlock",{block:r,id:Bn.name,type:"slot",source:"(28:12) <Link href={remultKitDataAuth.providers?.password.paths.sign_in}>",ctx:i}),r}function qn(i){var a;let e,t,r,n;e=new Si({props:{remultKitDataAuth:i[0]},$$inline:!0});let s=((a=i[0].providers)==null?void 0:a.password.paths.sign_in)&&Ln(i);const o={c:function(){Fe(e.$$.fragment),t=be(),r=W("div"),s&&s.c(),te(r,"class","form-footer s-NO-a_LAEXXH5"),$(r,Ae,29,8,900)},m:function(f,u){Pe(e,f,u),re(f,t,u),re(f,r,u),s&&s.m(r,null),n=!0},p:function(f,u){var d;(d=f[0].providers)!=null&&d.password.paths.sign_in&&s.p(f,u)},i:function(f){n||(ue(e.$$.fragment,f),ue(s),n=!0)},o:function(f){de(e.$$.fragment,f),de(s),n=!1},d:function(f){f&&(ie(t),ie(r)),Re(e,f),s&&s.d()}};return K("SvelteRegisterBlock",{block:o,id:qn.name,type:"slot",source:"(23:6) <Route path={remultKitDataAuth.providers?.password.paths.forgot_password}>",ctx:i}),o}function jn(i){let e,t,r,n,s;const o={c:function(){e=W("div"),t=W("small"),t.textContent="- 404 -",r=be(),n=W("div"),s=W("small"),s.textContent="Nothing to see here",$(t,Ae,40,10,1277),te(e,"class","fallback s-NO-a_LAEXXH5"),$(e,Ae,39,8,1244),$(s,Ae,43,10,1356),te(n,"class","fallback s-NO-a_LAEXXH5"),$(n,Ae,42,8,1323)},m:function(l,f){re(l,e,f),J(e,t),re(l,r,f),re(l,n,f),J(n,s)},p:me,d:function(l){l&&(ie(e),ie(r),ie(n))}};return K("SvelteRegisterBlock",{block:o,id:jn.name,type:"slot",source:"(35:6) <Route fallback>",ctx:i}),o}function Jn(i){var l,f;let e,t,r,n,s,o;e=new at({props:{path:(l=i[0].providers)==null?void 0:l.password.paths.sign_in,$$slots:{default:[Nn]},$$scope:{ctx:i}},$$inline:!0}),r=new at({props:{path:(f=i[0].providers)==null?void 0:f.password.paths.forgot_password,$$slots:{default:[qn]},$$scope:{ctx:i}},$$inline:!0}),s=new at({props:{fallback:!0,$$slots:{default:[jn]},$$scope:{ctx:i}},$$inline:!0});const a={c:function(){Fe(e.$$.fragment),t=be(),Fe(r.$$.fragment),n=be(),Fe(s.$$.fragment)},m:function(d,p){Pe(e,d,p),re(d,t,p),Pe(r,d,p),re(d,n,p),Pe(s,d,p),o=!0},p:function(d,p){const y={};p&4&&(y.$$scope={dirty:p,ctx:d}),e.$set(y);const w={};p&4&&(w.$$scope={dirty:p,ctx:d}),r.$set(w);const k={};p&4&&(k.$$scope={dirty:p,ctx:d}),s.$set(k)},i:function(d){o||(ue(e.$$.fragment,d),ue(r.$$.fragment,d),ue(s.$$.fragment,d),o=!0)},o:function(d){de(e.$$.fragment,d),de(r.$$.fragment,d),de(s.$$.fragment,d),o=!1},d:function(d){d&&(ie(t),ie(n)),Re(e,d),Re(r,d),Re(s,d)}};return K("SvelteRegisterBlock",{block:a,id:Jn.name,type:"slot",source:"(10:4) <Route>",ctx:i}),a}function br(i){let e,t,r,n;r=new at({props:{$$slots:{default:[Jn]},$$scope:{ctx:i}},$$inline:!0});const s={c:function(){e=W("div"),t=W("div"),Fe(r.$$.fragment),te(t,"class","form s-NO-a_LAEXXH5"),$(t,Ae,12,2,282),te(e,"class","wrapper s-NO-a_LAEXXH5"),$(e,Ae,11,0,258)},l:function(a){throw new Error("options.hydrate only works if the component was compiled with the `hydratable: true` option")},m:function(a,l){re(a,e,l),J(e,t),Pe(r,t,null),n=!0},p:function(a,[l]){const f={};l&4&&(f.$$scope={dirty:l,ctx:a}),r.$set(f)},i:function(a){n||(ue(r.$$.fragment,a),n=!0)},o:function(a){de(r.$$.fragment,a),n=!1},d:function(a){a&&ie(e),Re(r)}};return K("SvelteRegisterBlock",{block:s,id:br.name,type:"component",source:"",ctx:i}),s}function Wo(i,e,t){let{$$slots:r={},$$scope:n}=e;mt("Page",r,[]);let{remultKitData:s}=e,o=s.props;i.$$.on_mount.push(function(){s===void 0&&!("remultKitData"in e||i.$$.bound[i.$$.props.remultKitData])&&console.warn("<Page> was created without expected prop 'remultKitData'")});const a=["remultKitData"];return Object.keys(e).forEach(l=>{!~a.indexOf(l)&&l.slice(0,2)!=="$$"&&l!=="slot"&&console.warn(`<Page> was created with unknown prop '${l}'`)}),i.$$set=l=>{"remultKitData"in l&&t(1,s=l.remultKitData)},i.$capture_state=()=>({Link:Or,Route:at,ForgotPassword:Si,SignUp:Rn,remultKitData:s,remultKitDataAuth:o}),i.$inject_state=l=>{"remultKitData"in l&&t(1,s=l.remultKitData),"remultKitDataAuth"in l&&t(0,o=l.remultKitDataAuth)},e&&"$$inject"in e&&i.$inject_state(e.$$inject),[o,s]}class Xo extends pt{constructor(e){super(e),yt(this,e,Wo,br,Ut,{remultKitData:1}),K("SvelteRegisterComponent",{component:this,tagName:"Page",options:e,id:br.name})}get remultKitData(){throw new Error("<Page>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set remultKitData(e){throw new Error("<Page>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}}export{Xo as default};
